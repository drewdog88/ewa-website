name: Simple Weekly Postgres Backup

on:
  schedule:
    - cron: '0 3 * * 0' # Runs weekly on Sundays at 3 AM UTC (Saturday 7 PM PST)
  workflow_dispatch: # Allows manual triggering from GitHub UI

env:
  # Define environment variables for your database and Vercel Blob
  DATABASE_URL: ${{ secrets.DATABASE_URL }} # PostgreSQL connection string
  BLOB_READ_WRITE_TOKEN: ${{ secrets.BLOB_READ_WRITE_TOKEN }} # Vercel Blob token
  FOLDER_NAME: postgres-backups

jobs:
  backup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install PostgreSQL client (version 17)
        run: |
          sudo apt-get update
          sudo apt-get install -y wget ca-certificates
          wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -
          echo "deb http://apt.postgresql.org/pub/repos/apt/ $(lsb_release -cs)-pgdg main" | sudo tee /etc/apt/sources.list.d/pgdg.list
          sudo apt-get update
          sudo apt-get install -y postgresql-client-17

      - name: Install Vercel CLI
        run: |
          npm install -g vercel@latest

      - name: Run comprehensive pg_dump and gzip
        run: |
          mkdir -p "${{ env.FOLDER_NAME }}"
          GZIP_NAME="${{ env.FOLDER_NAME }}/ewa-db-weekly-$(date +%Y-%m-%d_%H-%M-%S).sql.gz"
          # Use pg_dump with comprehensive options for weekly backup
          /usr/lib/postgresql/17/bin/pg_dump \
            --verbose \
            --no-owner \
            --no-privileges \
            --clean \
            --if-exists \
            --create \
            "${{ env.DATABASE_URL }}" | gzip > "${GZIP_NAME}"
          echo "GZIP_NAME=${GZIP_NAME}" >> $GITHUB_ENV
          echo "ğŸ“Š Created weekly backup: ${GZIP_NAME}"
          ls -lh "${GZIP_NAME}"

      - name: Upload to Vercel Blob
        env:
          BLOB_READ_WRITE_TOKEN: ${{ secrets.BLOB_READ_WRITE_TOKEN }}
        run: |
          echo "ğŸ“¤ Uploading weekly backup to Vercel Blob using Vercel CLI..."
          vercel blob put "${{ env.GZIP_NAME }}" --token="$BLOB_READ_WRITE_TOKEN"
          echo "âœ… Uploaded weekly backup to Vercel Blob: ${{ env.GZIP_NAME }}"

      - name: Backup Summary
        run: |
          echo "ğŸ‰ Weekly pg_dump backup completed successfully!"
          echo "ğŸ“ Backup file: ${{ env.GZIP_NAME }}"
          echo "ğŸ“… Date: $(date)"
          echo "ğŸ’¾ Storage: Vercel Blob"
          echo "ğŸ”’ Safety: All backups preserved (no automatic cleanup)"
          echo "ğŸ“‹ Weekly backup includes: schema, data, and restore instructions"

      - name: Upload backup logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: weekly-backup-logs-${{ github.run_number }}
          path: |
            ${{ env.FOLDER_NAME }}/
          retention-days: 30

      - name: Notify on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const issue = await github.rest.issues.create({
              owner,
              repo,
              title: 'ğŸš¨ Weekly Database Backup Failed',
              body: `Weekly database backup failed on ${new Date().toISOString()}.
              
              **Workflow Run:** ${context.serverUrl}/${owner}/${repo}/actions/runs/${context.runId}
              
              This is a critical failure that affects our backup strategy. Please investigate immediately.`,
              labels: ['backup-failure', 'critical', 'weekly-backup']
            });
            console.log(`Created issue #${issue.data.number} for weekly backup failure`);
