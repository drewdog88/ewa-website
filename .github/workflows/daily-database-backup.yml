name: Daily Database Backup

on:
  schedule:
    - cron: '0 2 * * *' # Runs daily at 2 AM UTC (6 PM PST previous day)
  workflow_dispatch: # Allows manual triggering from GitHub UI

env:
  # Define environment variables for your database and Vercel Blob
  DATABASE_URL: ${{ secrets.DATABASE_URL }} # PostgreSQL connection string
  BLOB_READ_WRITE_TOKEN: ${{ secrets.BLOB_READ_WRITE_TOKEN }} # Vercel Blob token

jobs:
  backup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install PostgreSQL client (version 17)
        run: |
          sudo apt-get update
          sudo apt-get install -y wget ca-certificates
          wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -
          echo "deb http://apt.postgresql.org/pub/repos/apt/ $(lsb_release -cs)-pgdg main" | sudo tee /etc/apt/sources.list.d/pgdg.list
          sudo apt-get update
          sudo apt-get install -y postgresql-client-17

      - name: Install Vercel CLI
        run: |
          npm install -g vercel@latest

      - name: Run pg_dump and gzip
        run: |
          GZIP_NAME="ewa-db-daily-$(date +%Y-%m-%d_%H-%M-%S).sql.gz"
          # Simple pg_dump for daily backup
          /usr/lib/postgresql/17/bin/pg_dump \
            --verbose \
            --no-owner \
            --no-privileges \
            "${{ env.DATABASE_URL }}" | gzip > "${GZIP_NAME}"
          echo "GZIP_NAME=${GZIP_NAME}" >> $GITHUB_ENV
          echo "ğŸ“Š Created daily backup: ${GZIP_NAME}"
          ls -lh "${GZIP_NAME}"

      - name: Upload to Vercel Blob
        env:
          BLOB_READ_WRITE_TOKEN: ${{ secrets.BLOB_READ_WRITE_TOKEN }}
        run: |
          echo "ğŸ“¤ Uploading to Vercel Blob using Vercel CLI..."
          vercel blob put "${{ env.GZIP_NAME }}" --token="$BLOB_READ_WRITE_TOKEN"
          echo "âœ… Uploaded backup to Vercel Blob: ${{ env.GZIP_NAME }}"

      - name: Backup Summary
        run: |
          echo "ğŸ‰ Daily database backup completed successfully!"
          echo "ğŸ“ Backup file: ${{ env.GZIP_NAME }}"
          echo "ğŸ“… Date: $(date)"
          echo "ğŸ’¾ Storage: Vercel Blob"
          echo "ğŸ”’ Safety: All backups preserved (no automatic cleanup)"