<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Vercel Analytics -->
    <script defer src="/_vercel/insights/script.js"></script>
    
    <!-- Vercel Speed Insights -->
    <script defer src="/_vercel/speed-insights/script.js"></script>
    
    <title>Admin Dashboard - Eastlake Wolfpack Association</title>
    <link rel="stylesheet" href="dashboard.css">
    <style>
        /* File upload styles */
        .file-upload-container {
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            background: #f9f9f9;
            transition: border-color 0.3s ease;
        }
        
        .file-upload-container:hover {
            border-color: #007bff;
        }
        
        .file-upload-container input[type="file"] {
            width: 100%;
            margin-bottom: 10px;
        }
        
        /* Top links list styles */
        .top-links-list {
            text-align: left;
            font-size: 14px;
        }
        
        .top-link-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .top-link-item:last-child {
            border-bottom: none;
        }
        
        .top-link-name {
            font-weight: 500;
            color: #333;
            flex: 1;
            margin-right: 10px;
        }
        
        .top-link-count {
            color: #666;
            font-size: 12px;
            background: #f8f9fa;
            padding: 2px 8px;
            border-radius: 12px;
        }
        
        .file-upload-info {
            color: #666;
        }
        
        .file-status {
            margin-top: 10px;
            padding: 8px;
            border-radius: 4px;
            font-weight: 500;
        }
        
        .file-status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .file-status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .file-link {
            color: #007bff;
            text-decoration: none;
            font-weight: 500;
        }
        
        .file-link:hover {
            text-decoration: underline;
        }
        
        .no-file {
            color: #6c757d;
            font-style: italic;
        }
        
        .status-pending {
            background: #fff3cd;
            color: #856404;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
        }
        
        .status-approved {
            background: #d4edda;
            color: #155724;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
        }
        
        .status-rejected {
            background: #f8d7da;
            color: #721c24;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
        }

        /* Backup Management Styles */
        .backup-status {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .status-card {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            text-align: center;
        }

        .status-card h3 {
            margin: 0 0 10px 0;
            color: #495057;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-card .value {
            font-size: 24px;
            font-weight: bold;
            color: #212529;
        }

        .status-card .success { color: #28a745; }
        .status-card .warning { color: #ffc107; }
        .status-card .danger { color: #dc3545; }

        .backup-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .backup-history {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
        }

        .backup-history h3 {
            margin-bottom: 20px;
            color: #495057;
        }
        
        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        /* Payment Management Styles */
        .payment-section {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            background-color: #f8f9fa;
        }

        .payment-section h4 {
            color: #495057;
            margin-bottom: 15px;
            border-bottom: 2px solid #007bff;
            padding-bottom: 5px;
        }

        .qr-preview {
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            background: white;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .qr-preview img {
            max-width: 200px;
            max-height: 200px;
        }

        .qr-preview .no-qr {
            color: #6c757d;
            font-style: italic;
        }

        .status-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .status-card {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
        }

        .status-card h4 {
            color: #495057;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .status-card .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #007bff;
        }

        .bulk-actions {
            display: flex;
            gap: 15px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .form-actions {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #dee2e6;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            font-weight: 500;
        }

        .checkbox-label input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }

        .checkbox-group {
            margin-top: 10px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 4px;
            border: 1px solid #dee2e6;
        }

        .checkbox-group label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-weight: 500;
            margin: 0;
        }

        .checkbox-group input[type="checkbox"] {
            width: 16px;
            height: 16px;
            margin: 0;
        }

        .table-actions {
            margin-bottom: 15px;
            display: flex;
            justify-content: flex-end;
        }

        .table-actions .btn {
            margin-left: 10px;
        }
        
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 0;
            border: 1px solid #888;
            border-radius: 8px;
            width: 80%;
            max-width: 600px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #ddd;
            background-color: #f8f9fa;
            border-radius: 8px 8px 0 0;
        }
        
        .modal-header h3 {
            margin: 0;
            color: #333;
        }
        
        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover,
        .close:focus {
            color: #000;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }
        
        .btn-secondary {
            background-color: #6c757d;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .btn-secondary:hover {
            background-color: #5a6268;
        }

        /* Security Report Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 10px;
            width: 90%;
            max-width: 1000px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px 10px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 24px;
        }

        .close {
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: opacity 0.3s;
        }

        .close:hover {
            opacity: 0.7;
        }

        .modal-body {
            padding: 30px;
            max-height: 60vh;
            overflow-y: auto;
        }

        .report-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .report-section h3 {
            margin-top: 0;
            color: #333;
            font-size: 20px;
        }

        .report-section h4 {
            color: #555;
            margin: 20px 0 10px 0;
        }

        .metric-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }

        .metric-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border: 1px solid #e9ecef;
        }

        .metric-value {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .metric-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .dependency-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }

        .dependency-stat {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .dependency-number {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .dependency-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
        }

        .recommendation-list {
            list-style: none;
            padding: 0;
        }

        .recommendation-list li {
            background: white;
            margin: 10px 0;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #ffc107;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .recommendation-priority {
            font-weight: bold;
            margin-bottom: 8px;
            padding: 4px 8px;
            border-radius: 4px;
            display: inline-block;
            font-size: 12px;
            text-transform: uppercase;
        }

        .priority-critical {
            background: #f8d7da;
            color: #721c24;
        }

        .priority-high {
            background: #fff3cd;
            color: #856404;
        }

        .priority-medium {
            background: #d1ecf1;
            color: #0c5460;
        }

        .priority-low {
            background: #d4edda;
            color: #155724;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="admin-header">
        <h1><div class="logo"></div>EWA Admin Dashboard</h1>
        <div class="header-buttons">
            <a href="../index.html" class="home-btn">Home</a>
            <div id="userButtonContainer"></div>
        </div>
    </div>
    
    <div class="admin-container">
        <div class="sidebar">
            <ul class="sidebar-nav" id="sidebarNav">
                <li><a href="#dashboard" class="nav-link active" data-section="dashboard">Dashboard</a></li>
                <li class="admin-only"><a href="#officers" class="nav-link" data-section="officers">Officer Management</a></li>
                <li class="admin-only"><a href="#club-websites" class="nav-link" data-section="club-websites">Club Website Links</a></li>
                <li><a href="#volunteers" class="nav-link" data-section="volunteers">Volunteer Signup Management</a></li>
                <li class="admin-only"><a href="#news" class="nav-link" data-section="news">News & Announcements</a></li>
                <li class="admin-only"><a href="#links" class="nav-link" data-section="links">Links & Resources</a></li>
                <li><a href="#insurance" class="nav-link" data-section="insurance">Insurance Forms</a></li>
                            <li><a href="#1099" class="nav-link" data-section="1099">1099 Information</a></li>
            <li><a href="#profile" class="nav-link" data-section="profile">Security Settings</a></li>
            <li class="admin-only"><a href="#security-dashboard" class="nav-link" data-section="security-dashboard">Security Dashboard</a></li>
                                           <li class="admin-only"><a href="#content" class="nav-link" data-section="content">Content Management</a></li>
                                           <li class="admin-only"><a href="#add-booster-club" class="nav-link" data-section="add-booster-club">Add New Club</a></li>
                               <li class="admin-only"><a href="#users" class="nav-link" data-section="users">User Management</a></li>
                               <li class="admin-only"><a href="backup-management.html" class="nav-link" target="_blank">Backup Management</a></li>
                <li class="admin-only"><a href="#payment-management" class="nav-link" data-section="payment-management">Payment Management</a></li>
            </ul>
        </div>
        
        <div class="main-content">
            <!-- Dashboard Section -->
            <div id="dashboard" class="content-section active">
                <div class="section-header">
                    <h2>Dashboard Overview</h2>
                    <p>Welcome to the EWA Admin Dashboard. Manage your booster clubs, content, and analytics from here.</p>
                </div>
                
                <div class="dashboard-grid">
                    <div class="dashboard-card">
                        <h3>Total Booster Clubs</h3>
                        <div class="stat-number">23</div>
                        <div class="stat-label">Active clubs</div>
                    </div>
                    
                    <div class="dashboard-card">
                        <h3>Total Officers</h3>
                        <div class="stat-number" id="totalOfficers">Loading...</div>
                        <div class="stat-label">Registered officers</div>
                    </div>
                    
                    <div class="dashboard-card">
                        <h3>Top 5 Links</h3>
                        <div class="top-links-list" id="topLinksList">Loading...</div>
                    </div>
                    
                    <div class="dashboard-card">
                        <h3>Site Visitors</h3>
                        <div class="stat-number" id="siteVisitors">Loading...</div>
                        <div class="stat-label">This month</div>
                    </div>
                </div>
                
                <div class="quick-actions">
                    <h3>Quick Actions</h3>
                    <div class="action-buttons">
                        <a href="#officers" class="action-btn nav-link" data-section="officers">Add New Officer</a>
                        <a href="#news" class="action-btn nav-link" data-section="news">Post News</a>
                        <a href="#documents" class="action-btn nav-link" data-section="documents">Review Documents</a>
                    </div>
                </div>
                
            </div>
            
            <!-- Officer Management Section -->
            <div id="officers" class="content-section">
                <div class="section-header">
                    <h2>Officer Management</h2>
                    <p>Manage booster club officers and import data from spreadsheets.</p>
                </div>
                
                <div class="form-section">
                    <h3>Import Officer Data</h3>
                    <div class="form-group">
                        <label for="spreadsheet">Upload Spreadsheet (CSV/Excel)</label>
                        <input type="file" id="spreadsheet" accept=".csv,.xlsx,.xls">
                    </div>
                    <div class="form-row">
                        <button class="action-btn" onclick="importOfficerData()">Import Data</button>
                        <button class="action-btn" onclick="downloadOfficerTemplate()" style="background-color: #28a745;">Download Template</button>
                    </div>
                </div>
                
                <div class="form-section">
                    <h3>Add New Officer</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="officerName">Name</label>
                            <input type="text" id="officerName" placeholder="Officer Name">
                        </div>
                        <div class="form-group">
                            <label for="officerPosition">Position</label>
                            <input type="text" id="officerPosition" placeholder="President, Treasurer, etc.">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="officerEmail">Email *</label>
                            <input type="email" id="officerEmail" placeholder="officer@example.com" required>
                        </div>
                        <div class="form-group">
                            <label for="officerPhone">Phone (optional)</label>
                            <input type="tel" id="officerPhone" placeholder="(425) 555-0101">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="boosterClub">Booster Club</label>
                        <select id="boosterClub">
                            <option value="">Select Booster Club</option>
                            <!-- Clubs will be loaded dynamically from database -->
                        </select>
                    </div>
                    <button class="action-btn" onclick="addOfficer()">Add Officer</button>
                    <button class="btn-secondary" onclick="cancelOfficerEdit()" id="cancelOfficerEdit" style="display: none;">Cancel Edit</button>
                </div>
                
                <div class="form-section">
                    <h3>Current Officers</h3>
                    <div id="officersTableContainer">
                        <table class="data-table" id="officersTable">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Position</th>
                                    <th>Club</th>
                                    <th>Email</th>
                                    <th>Phone</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="officersTableBody">
                                <!-- Officers will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Club Website Links Section -->
            <div id="club-websites" class="content-section">
                <div class="section-header">
                    <h2>Club Website Links Management</h2>
                    <p>Manage website links for each booster club. These links appear as "Visit Website" buttons on the main page.</p>
                </div>
                
                <div class="form-section">
                    <h3>Edit Club Website Links</h3>
                    <div class="form-group">
                        <label for="websiteClubSelect">Select Club</label>
                        <select id="websiteClubSelect">
                            <option value="">Select Booster Club</option>
                            <!-- Clubs will be loaded dynamically from database -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="websiteUrl">Website URL</label>
                        <input type="url" id="websiteUrl" placeholder="https://example.com">
                    </div>
                    <div class="form-group">
                        <label for="websiteEnabled">
                            <input type="checkbox" id="websiteEnabled" checked>
                            Enable "Visit Website" button for this club
                        </label>
                    </div>
                    <button class="action-btn" onclick="updateWebsiteLink()">Update Website Link</button>
                </div>
                
                <div class="form-section">
                    <h3>Current Website Links</h3>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Club Name</th>
                                <th>Website URL</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="websiteLinksTableBody">
                            <!-- Website links will be dynamically added here -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Volunteer Management Section -->
            <div id="volunteers" class="content-section">
                <div class="section-header">
                    <h2>Volunteer Management</h2>
                    <p>View and manage volunteer interest submissions for your booster club.</p>
                </div>
                
                <div class="form-section">
                    <h3>Filter Volunteers</h3>
                    <div class="form-group">
                        <label for="volunteerClubFilter">Filter by Club</label>
                        <select id="volunteerClubFilter">
                            <option value="">All Clubs</option>
                            <!-- Clubs will be loaded dynamically from database -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="volunteerStatusFilter">Filter by Status</label>
                        <select id="volunteerStatusFilter">
                            <option value="">All Statuses</option>
                            <option value="pending">Pending</option>
                            <option value="contacted">Contacted</option>
                            <option value="confirmed">Confirmed</option>
                            <option value="declined">Declined</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-section">
                    <h3>Volunteer Submissions</h3>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Booster Club</th>
                                <th>Volunteer Name</th>
                                <th>Child's Name</th>
                                <th>Email</th>
                                <th>Phone</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                                            <tbody>
                        <!-- Volunteer data will be loaded dynamically -->
                    </tbody>
                    </table>
                </div>
                
                <div class="form-section">
                    <h3>Export Volunteer Data</h3>
                    <p>Download volunteer submissions for your club in CSV format.</p>
                    <button class="action-btn" onclick="exportVolunteerData()">Export to CSV</button>
                </div>
            </div>
            
            <!-- News Management Section -->
            <div id="news" class="content-section">
                <div class="section-header">
                    <h2>News & Announcements</h2>
                    <p>Manage news posts and meeting minutes.</p>
                </div>
                
                <div class="form-section">
                    <h3>Add News Post</h3>
                    <div class="form-group">
                        <label for="newsTitle">Title</label>
                        <input type="text" id="newsTitle" placeholder="News Title">
                    </div>
                    <div class="form-group">
                        <label for="newsContent">Content</label>
                        <textarea id="newsContent" placeholder="News content..."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="newsDate">Date</label>
                        <input type="date" id="newsDate">
                    </div>
                    <button class="action-btn">Publish News</button>
                </div>
                
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Title</th>
                            <th>Content</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>2025-01-15</td>
                            <td>Next Board Meeting - January 20th</td>
                            <td>Join us for our monthly board meeting...</td>
                            <td>
                                <button class="btn-small">Edit</button>
                                <button class="btn-small">Delete</button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- Links Management Section -->
            <div id="links" class="content-section">
                <div class="section-header">
                    <h2>Links & Resources</h2>
                    <p>Manage external links and track their usage.</p>
                </div>
                
                <div class="form-section">
                    <h3>Add New Link</h3>
                    <form id="addLinkForm" onsubmit="addLink(event)">
                        <div class="form-group">
                            <label for="linkTitle">Title *</label>
                            <input type="text" id="linkTitle" placeholder="Link Title" required>
                        </div>
                        <div class="form-group">
                            <label for="linkUrl">URL *</label>
                            <input type="url" id="linkUrl" placeholder="https://example.com" required>
                            <div id="urlError" class="error-message" style="display: none; color: #dc3545; font-size: 12px; margin-top: 5px;"></div>
                        </div>
                        <div class="form-group">
                            <label for="linkCategory">Category</label>
                            <select id="linkCategory">
                                <option value="athletics">Athletics</option>
                                <option value="booster">Booster Clubs</option>
                                <option value="community">Community</option>
                                <option value="resources">Resources</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <button type="submit" id="addLinkBtn" class="action-btn">Add Link</button>
                    </form>
                </div>
                
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Title</th>
                            <th>URL</th>
                            <th>Category</th>
                            <th>Clicks</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Links will be dynamically loaded here -->
                    </tbody>
                </table>
            </div>
            
            <!-- Insurance Forms Section -->
            <div id="insurance" class="content-section">
                <div class="section-header">
                    <h2>Insurance Forms</h2>
                    <p>Submit event and activity information for insurance purposes.</p>
                </div>
                
                <div class="form-section">
                    <h3>Submit Insurance Form</h3>
                    <form id="insuranceForm" onsubmit="submitInsuranceForm(event)">
                        <div class="form-group">
                            <label for="insuranceBoosterClub">Booster Club *</label>
                            <select id="insuranceBoosterClub" required>
                                <option value="">Select Booster Club</option>
                                <!-- Clubs will be loaded dynamically from database -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="insuranceEventName">Event/Activity Name *</label>
                            <input type="text" id="insuranceEventName" placeholder="Event Name" required>
                        </div>
                        <div class="form-group">
                            <label for="insuranceEventDate">Event Date *</label>
                            <input type="date" id="insuranceEventDate" required>
                        </div>
                        <div class="form-group">
                            <label for="insuranceEventDescription">Event Description *</label>
                            <textarea id="insuranceEventDescription" placeholder="Describe the event, activities, and any special requirements..." required></textarea>
                        </div>
                        <div class="form-group">
                            <label for="insuranceParticipantCount">Expected Participants</label>
                            <input type="number" id="insuranceParticipantCount" placeholder="Number of participants" min="1" oninput="validateParticipantCount(this)">
                            <div id="participantCountError" class="error-message" style="display: none; color: #dc3545; font-size: 12px; margin-top: 5px;"></div>
                        </div>
                        <button type="submit" id="submitInsuranceBtn" class="action-btn">Submit Insurance Form</button>
                    </form>
                </div>
                
                <div class="form-section">
                    <h3>Your Insurance Submissions</h3>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h4>Insurance Submissions</h4>
                        <button class="btn btn-success btn-sm" onclick="downloadInsuranceCSV()">üì• Download CSV</button>
                    </div>
                    <table class="data-table" id="insuranceTable">
                        <thead>
                            <tr>
                                <th>Date Submitted</th>
                                <th>Booster Club</th>
                                <th>Event Name</th>
                                <th>Event Date</th>
                                <th>Description</th>
                                <th>Participants</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Data will be loaded dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- 1099 Information Section -->
            <div id="1099" class="content-section">
                <div class="section-header">
                    <h2>1099 Information</h2>
                    <p>Submit 1099 information for vendors and contractors.</p>
                </div>
                
                <div class="form-section">
                    <h3>Submit 1099 Information</h3>
                    <div class="form-group">
                        <label for="1099RecipientName">Recipient Name *</label>
                        <input type="text" id="1099RecipientName" placeholder="Recipient Name" required>
                    </div>
                    <div class="form-group">
                        <label for="1099RecipientTin">Tax ID (SSN or EIN) *</label>
                        <input type="text" id="1099RecipientTin" placeholder="123-45-6789 or 12-3456789" required>
                    </div>
                    <div class="form-group">
                        <label for="1099Amount">Payment Amount *</label>
                        <input type="number" id="1099Amount" placeholder="0.00" step="0.01" min="0" required oninput="validatePaymentAmount(this)">
                        <div id="amountError" class="error-message" style="display: none; color: #dc3545; font-size: 12px; margin-top: 5px;"></div>
                    </div>
                    <div class="form-group">
                        <label for="1099Description">Description</label>
                        <textarea id="1099Description" placeholder="Description of services or goods" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="1099BoosterClub">Booster Club *</label>
                        <select id="1099BoosterClub" required>
                            <option value="">Select Booster Club</option>
                            <!-- Clubs will be loaded dynamically from database -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="1099TaxYear">Calendar Year *</label>
                        <select id="1099TaxYear" required>
                            <option value="">Select Calendar Year</option>
                            <option value="2024">2024</option>
                            <option value="2025">2025</option>
                            <option value="2026">2026</option>
                        </select>
                    </div>
                    
                    <!-- W9 File Upload Section -->
                    <div class="form-group">
                        <label for="1099W9File">W9 Form Upload *</label>
                        <div class="file-upload-container">
                            <input type="file" id="1099W9File" accept=".pdf,.jpg,.jpeg,.png,.gif" required>
                            <div class="file-upload-info">
                                <small>Accepted formats: PDF, JPG, PNG, GIF (Max 10MB)</small>
                                <div id="w9FileStatus" class="file-status"></div>
                            </div>
                        </div>
                    </div>
                    
                    <button class="action-btn" onclick="submit1099Form()" id="submit1099Btn">Submit 1099 Information</button>
                </div>
                
                <div class="form-section">
                    <h3>Your 1099 Submissions</h3>
                    
                    <!-- Filter and Export Controls -->
                    <div style="margin-bottom: 15px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <label for="yearFilter" style="font-weight: bold; margin-right: 5px;">Filter by Year:</label>
                            <select id="yearFilter" onchange="filter1099ByYear()" style="padding: 5px; border: 1px solid #ddd; border-radius: 4px;">
                                <option value="">All Years</option>
                                <option value="2024">2024</option>
                                <option value="2025">2025</option>
                                <option value="2026">2026</option>
                            </select>
                        </div>
                        
                        <button class="action-btn" onclick="load1099Data()" id="load1099Btn" style="background-color: #17a2b8;">
                            üìä Load Data
                        </button>
                        
                        <button class="action-btn" onclick="refresh1099Data()" id="refresh1099Btn" style="background-color: #007bff;">
                            üîÑ Refresh Submissions
                        </button>
                        
                        <button class="action-btn" onclick="exportSelected1099()" id="export1099Btn" style="background-color: #28a745; margin-right: 10px;">
                            üìä Export Selected (CSV)
                        </button>
                        
                        <button class="action-btn" onclick="downloadSelectedW9()" id="downloadW9Btn" style="background-color: #ffc107; color: #000; margin-right: 10px;">
                            üìÅ Download W9 Files (ZIP)
                        </button>
                        
                        <span style="font-size: 14px; color: #666;">
                            Select items to export or download W9 files
                        </span>
                    </div>
                    <table class="data-table" id="1099Table">
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="selectAll1099" onchange="toggleSelectAll1099()"></th>
                                <th>Date Submitted</th>
                                <th>Recipient Name</th>
                                <th>Tax ID</th>
                                <th>Amount</th>
                                <th>Calendar Year</th>
                                <th>Booster Club</th>
                                <th>W9 Form</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Data will be loaded dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            
            <!-- Content Management Section -->
            <div id="content" class="content-section">
                <div class="section-header">
                    <h2>Content Management</h2>
                    <p>Edit booster club descriptions and manage site content.</p>
                </div>
                
                <div class="form-section">
                    <h3>Edit Booster Club Description</h3>
                    <div class="form-group">
                        <label for="clubSelect">Select Club</label>
                        <select id="clubSelect" onchange="loadClubDescription()">
                            <option value="">Select Booster Club</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="clubDescription">Description</label>
                        <textarea id="clubDescription" placeholder="Enter the club's description..."></textarea>
                    </div>
                    <button class="action-btn" onclick="updateClubDescription()">Update Description</button>
                </div>
            </div>
            
            <!-- Add New Booster Club Section -->
            <div id="add-booster-club" class="content-section">
                <div class="section-header">
                    <h2>Add New Booster Club</h2>
                    <p>Create a new booster club with just a name. All other settings can be configured later using existing admin tools.</p>
                </div>
                
                <div class="form-section">
                    <h3>Club Name</h3>
                    <div class="form-group">
                        <label for="newClubName">Club Name *</label>
                        <input type="text" id="newClubName" placeholder="Enter club name" required>
                    </div>
                    <div class="form-info">
                        <h4>After Creation:</h4>
                        <ul>
                            <li>Description: Use "Content Management" section</li>
                            <li>Website URL: Use "Content Management" section</li>
                            <li>Payment Settings: Use "Payment Management" section</li>
                            <li>Officers: Use "Officer Management" section</li>
                        </ul>
                    </div>
                    <button class="action-btn" onclick="createNewBoosterClub()">Create Booster Club</button>
                </div>
            </div>
            
            <!-- Security Settings Section -->
            <div id="profile" class="content-section">
                <div class="section-header">
                    <h2>Security Settings</h2>
                    <p>Manage your account settings and security.</p>
                </div>
                
                <div class="form-section">
                    <h3>Change Password</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="currentPassword">Current Password</label>
                            <input type="password" id="currentPassword" placeholder="Current Password">
                        </div>
                        <div class="form-group">
                            <label for="newPasswordProfile">New Password</label>
                            <input type="password" id="newPasswordProfile" placeholder="New Password">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="confirmPassword">Confirm New Password</label>
                            <input type="password" id="confirmPassword" placeholder="Confirm New Password">
                        </div>
                    </div>
                    <button class="action-btn" onclick="changePassword()">Change Password</button>
                </div>
                
                <div class="form-section" id="firstLoginSetup" style="display: none;">
                    <h3>First Login Setup</h3>
                    <p>Please set up your secret question and answer for password recovery.</p>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="secretQuestion">Secret Question</label>
                            <input type="text" id="secretQuestion" placeholder="e.g., What was your first pet's name?">
                        </div>
                        <div class="form-group">
                            <label for="secretAnswer">Secret Answer</label>
                            <input type="text" id="secretAnswer" placeholder="Your answer">
                        </div>
                    </div>
                    <button class="action-btn" onclick="setupProfile()">Complete Setup</button>
                </div>
                
                <div class="form-section">
                    <h3>Forgot Password</h3>
                    <p>Reset your password using your secret question and answer.</p>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="forgotUsername">Username</label>
                            <input type="text" id="forgotUsername" placeholder="Your username">
                        </div>
                    </div>
                    <button class="action-btn" onclick="getSecretQuestion()">Get Secret Question</button>
                    
                    <div id="secretQuestionSection" style="display: none;">
                        <div class="form-row">
                            <div class="form-group">
                                <label id="secretQuestionLabel">Secret Question</label>
                                <input type="text" id="secretQuestionAnswer" placeholder="Your answer">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="newPasswordForgot">New Password</label>
                                <input type="password" id="newPasswordForgot" placeholder="New Password">
                            </div>
                            <div class="form-group">
                                <label for="confirmPasswordForgot">Confirm New Password</label>
                                <input type="password" id="confirmPasswordForgot" placeholder="Confirm New Password">
                            </div>
                        </div>
                        <button class="action-btn" onclick="resetPassword()">Reset Password</button>
                    </div>
                </div>
            </div>
            
            <!-- Security Dashboard Section -->
            <div id="security-dashboard" class="content-section">
                <div class="section-header">
                    <h2>Security Dashboard</h2>
                    <p>Monitor security posture, vulnerabilities, and code coverage for the EWA website.</p>
                </div>
                
                <div class="security-overview">
                    <div class="security-metrics">
                        <div class="metric-card">
                            <h3>Security Score</h3>
                            <div class="metric-value" id="securityScore">Loading...</div>
                            <div class="metric-label">Overall security rating</div>
                        </div>
                        
                        <div class="metric-card">
                            <h3>Vulnerabilities</h3>
                            <div class="metric-value" id="vulnerabilityCount">Loading...</div>
                            <div class="metric-label">Total issues found</div>
                        </div>
                        
                        <div class="metric-card">
                            <h3>Code Coverage</h3>
                            <div class="metric-value" id="codeCoverage">Loading...</div>
                            <div class="metric-label">Test coverage percentage</div>
                        </div>
                    </div>
                    
                    <div class="security-actions">
                        <button class="action-btn" onclick="runSecurityScan()">üîç Run Security Scan</button>
                        <button class="action-btn" onclick="runTestCoverage()">üß™ Run Test Coverage</button>
                        <button class="action-btn secondary" onclick="viewSecurityReport()">üìÑ View Full Report</button>
                    </div>
                </div>
                
                <div class="security-details">
                    <div class="vulnerability-breakdown">
                        <h3>Vulnerability Breakdown</h3>
                        <div class="vuln-stats">
                            <div class="vuln-item critical">
                                <span class="vuln-label">Critical:</span>
                                <span class="vuln-count" id="criticalCount">0</span>
                            </div>
                            <div class="vuln-item high">
                                <span class="vuln-label">High:</span>
                                <span class="vuln-count" id="highCount">0</span>
                            </div>
                            <div class="vuln-item moderate">
                                <span class="vuln-label">Moderate:</span>
                                <span class="vuln-count" id="moderateCount">0</span>
                            </div>
                            <div class="vuln-item low">
                                <span class="vuln-label">Low:</span>
                                <span class="vuln-count" id="lowCount">0</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="recommendations">
                        <h3>Security Recommendations</h3>
                        <div id="securityRecommendations" class="recommendations-list">
                            <p>Run a security scan to see recommendations.</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- User Management Section -->
            <div id="users" class="content-section">
                <div class="section-header">
                    <h2>User Management</h2>
                    <p>Manage admin users and Booster Club Admin accounts.</p>
                </div>
                
                <div class="form-section">
                    <h3>Add New User</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="newUsername">Username</label>
                            <input type="text" id="newUsername" placeholder="Username">
                        </div>
                        <div class="form-group">
                            <label for="newPassword">Password</label>
                            <input type="password" id="newPassword" placeholder="Password">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="userRole">Role</label>
                            <select id="userRole">
                                <option value="admin">Admin</option>
                                <option value="booster_admin">Booster Club Admin</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="userClub">Club (for Booster Admin)</label>
                            <select id="userClub">
                                <option value="">Select Club</option>
                                <!-- Clubs will be loaded dynamically from database -->
                            </select>
                        </div>
                    </div>
                    <button class="action-btn" onclick="addUser()">Add User</button>
                </div>
                
                <div class="form-section">
                    <h3>User List</h3>
                    <div id="usersTableContainer">
                        <table class="data-table" id="usersTable">
                            <thead>
                                <tr>
                                    <th>Username</th>
                                    <th>Role</th>
                                    <th>Club</th>
                                    <th>Status</th>
                                    <th>Last Login</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody">
                                <!-- Users will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>



            <!-- Payment Management Section -->
            <div id="payment-management" class="content-section">
                <div class="section-header">
                    <h2>Payment Management</h2>
                    <p>Manage Zelle and Stripe payment links for each booster club.</p>
                </div>
                
                <div class="form-section">
                    <h3>Payment Status Overview</h3>
                    <div class="status-overview">
                        <div class="status-card">
                            <h4>Clubs with Zelle</h4>
                            <div class="stat-number" id="clubsWithZelle">Loading...</div>
                        </div>
                        <div class="status-card">
                            <h4>Clubs with Stripe</h4>
                            <div class="stat-number" id="clubsWithStripe">Loading...</div>
                        </div>
                        <div class="status-card">
                            <h4>Payment Enabled</h4>
                            <div class="stat-number" id="paymentEnabled">Loading...</div>
                        </div>
                        <div class="status-card">
                            <h4>Total Clubs</h4>
                            <div class="stat-number" id="totalClubs">Loading...</div>
                        </div>
                    </div>
                </div>
                
                <div class="form-section">
                    <h3>Zelle Payment Links</h3>
                    <div class="form-group">
                        <label for="zelleClubSelect">Select Club</label>
                        <select id="zelleClubSelect">
                            <option value="">Select Booster Club</option>
                            <!-- Clubs will be loaded dynamically from database -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="zelleUrl">Zelle URL</label>
                        <input type="url" id="zelleUrl" placeholder="https://zelle.com/...">
                        <small>This URL will be used to generate the QR code for payments</small>
                        <div class="checkbox-group">
                            <label for="zelleEnabled">
                                <input type="checkbox" id="zelleEnabled" checked>
                                Enable Zelle payments for this club
                            </label>
                        </div>
                    </div>
                    <button class="action-btn" onclick="updateZelleLink()">Update Zelle Link</button>
                </div>
                
                <div class="form-section">
                    <h3>Stripe Payment Links</h3>
                    <div class="form-group">
                        <label for="stripeClubSelect">Select Club</label>
                        <select id="stripeClubSelect">
                            <option value="">Select Booster Club</option>
                            <!-- Clubs will be loaded dynamically from database -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="stripeUrl">Stripe Payment Link</label>
                        <input type="url" id="stripeUrl" placeholder="https://checkout.stripe.com/...">
                        <small>This single link handles donations, membership, and fees</small>
                        <div class="checkbox-group">
                            <label for="stripeEnabled">
                                <input type="checkbox" id="stripeEnabled" checked>
                                Enable Stripe payments for this club
                            </label>
                        </div>
                    </div>
                    <button class="action-btn" onclick="updateStripeLinks()">Update Stripe Link</button>
                </div>

                <div class="form-section">
                    <h3>Current Payment Links</h3>
                    <div class="table-actions">
                        <button type="button" id="exportPaymentData" class="btn btn-success">üìä Export Payment Data (CSV)</button>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Club Name</th>
                                <th>Zelle URL</th>
                                <th>Stripe Links</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="paymentLinksTableBody">
                            <!-- Payment links will be dynamically added here -->
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>

    <script src="../assets/user-session.js"></script>
    <script>
        // Global flag to prevent data loading during logout
        let isLoggingOut = false;
        
        // Navigation functionality - moved inside DOMContentLoaded
        function setupNavigation() {
            console.log('Found nav links:', document.querySelectorAll('.nav-link').length);
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    console.log('Nav link clicked:', this.href, 'target:', this.getAttribute('target'));
                    // Allow external links (like backup-management.html) to work normally
                    if (this.getAttribute('target') === '_blank' || this.href.includes('.html')) {
                        console.log('Allowing external link to work normally');
                        return; // Don't prevent default, let the link work normally
                    }
                    
                    e.preventDefault();
                    
                    // Remove active class from all links and sections
                    document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                    document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
                    
                    // Add active class to clicked link
                    this.classList.add('active');
                    
                    // Show corresponding section
                    const sectionId = this.getAttribute('data-section');
                    document.getElementById(sectionId).classList.add('active');
                    
                    // Update URL hash for proper browser navigation
                    window.location.hash = sectionId;
                    
                    // Load security dashboard data when that section is shown
                    if (sectionId === 'security-dashboard') {
                        loadSecurityDashboardData();
                    }
                    
                    // Load content management data when section is shown
                    if (sectionId === 'content') {
                        loadContentManagementData();
                    }
                });
            });
        }
        
        // Prevent AI training
        document.addEventListener('contextmenu', e => e.preventDefault());
        document.addEventListener('selectstart', e => e.preventDefault());
        
        // Store volunteer data globally for filtering
        let allVolunteerData = [];
        
        // Store booster clubs globally
        let allBoosterClubs = [];
        
        // Load booster clubs from database (single source of truth)
        function loadBoosterClubs() {
            fetch('/api/booster-clubs')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        allBoosterClubs = data.data;
                        populateAllClubDropdowns();
                    } else {
                        console.error('Error loading booster clubs:', data.message);
                    }
                })
                .catch(error => {
                    console.error('Error loading booster clubs:', error);
                });
        }
        
                            // Populate all club dropdowns with database data
                    function populateAllClubDropdowns() {
                        // Define all dropdown IDs that need to be populated
                        const clubDropdowns = [
                            'boosterClub',
                            'websiteClubSelect', 
                            'volunteerClubFilter',
                            'officerClubFilter',
                            'insuranceClubFilter',
                            '1099ClubFilter',
                            'insuranceBoosterClub',
                            '1099BoosterClub',
                            'userClub',
                            'editOfficerClub',
                            'editBoosterClub',
                            'zelleClubSelect',
                            'stripeClubSelect',
                            'clubSelect'
                        ];
                        
                        clubDropdowns.forEach(dropdownId => {
                            const dropdown = document.getElementById(dropdownId);
                            if (dropdown) {
                                // Keep the first "Select" option
                                const firstOption = dropdown.querySelector('option');
                                dropdown.innerHTML = '';
                                if (firstOption) {
                                    dropdown.appendChild(firstOption);
                                }
                                
                                // Add clubs from database
                                allBoosterClubs.forEach(club => {
                                    const option = document.createElement('option');
                                    
                                    // Handle different value formats based on dropdown type
                                    if (dropdownId === 'insuranceBoosterClub') {
                                        // Insurance dropdown uses UUIDs as values
                                        option.value = club.id;
                                        option.textContent = club.name;
                                    } else {
                                        // All other dropdowns use club names as values
                                        option.value = club.name;
                                        option.textContent = club.name;
                                    }
                                    
                                    dropdown.appendChild(option);
                                });
                            }
                        });
                    }
        
        // Load volunteer data
        function loadVolunteerData() {
            // Get current user to determine what data to load
            const currentUser = userSession.currentUser || {};
            
            let url = '/api/volunteers';
            if ((currentUser.role === 'booster_admin' || currentUser.role === 'booster_officer') && currentUser.club) {
                url = `/api/volunteers/${currentUser.club}`;
            }
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        allVolunteerData = data.volunteers; // Store all data
                        displayVolunteerData(allVolunteerData);
                    } else {
                        console.error('Error loading volunteers:', data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }
        
        // Display volunteer data in table
        function displayVolunteerData(volunteers) {
            const tbody = document.querySelector('#volunteers .data-table tbody');
            if (!tbody) return;
            
            // Get filter values
            const clubFilter = document.getElementById('volunteerClubFilter').value;
            const statusFilter = document.getElementById('volunteerStatusFilter').value;
            
            // Filter volunteers based on selected criteria
            let filteredVolunteers = volunteers.filter(volunteer => {
                const clubMatch = !clubFilter || volunteer.club === clubFilter;
                const statusMatch = !statusFilter || volunteer.status === statusFilter;
                return clubMatch && statusMatch;
            });
            
            tbody.innerHTML = '';
            
            filteredVolunteers.forEach(volunteer => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${new Date(volunteer.created_at).toLocaleDateString()}</td>
                    <td>${volunteer.club}</td>
                    <td>${volunteer.name}</td>
                    <td>${volunteer.interests || ''}</td>
                    <td>${volunteer.email}</td>
                    <td>${volunteer.phone || ''}</td>
                    <td><span class="status-${volunteer.status === 'pending' ? 'active' : volunteer.status === 'contacted' ? 'warning' : volunteer.status === 'confirmed' ? 'success' : 'inactive'}">${volunteer.status}</span></td>
                    <td>
                        ${volunteer.status === 'pending' ? `
                            <button class="btn-small" onclick="updateVolunteerStatus('${volunteer.id}', 'contacted')">Contact</button>
                            <button class="btn-small" onclick="updateVolunteerStatus('${volunteer.id}', 'confirmed')">Confirm</button>
                            <button class="btn-small" onclick="updateVolunteerStatus('${volunteer.id}', 'declined')">Decline</button>
                        ` : volunteer.status === 'contacted' ? `
                            <button class="btn-small" onclick="updateVolunteerStatus('${volunteer.id}', 'confirmed')">Confirm</button>
                            <button class="btn-small" onclick="updateVolunteerStatus('${volunteer.id}', 'declined')">Decline</button>
                        ` : `
                            <button class="btn-small" onclick="viewVolunteerDetails('${volunteer.id}')">View Details</button>
                        `}
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // Helper function to get club display name
        function getClubDisplayName(clubCode) {
            const clubNames = {
                'band': 'Eastlake Band Boosters',
                'baseball': 'Eastlake Baseball Club',
                'boys-basketball': 'Eastlake Boys Basketball Booster Club',
                'girls-basketball': 'Eastlake Girls Basketball Booster Club',
                'cheer': 'Eastlake Cheer Booster Club',
                'choir': 'Eastlake Choir',
                'cross-country': 'Eastlake Cross-Country Boosters',
                'dance': 'Eastlake Dance Team Boosters',
                'deca': 'Eastlake DECA Booster Club',
                'drama': 'Eastlake Drama Boosters',
                'fastpitch': 'Eastlake Fastpitch (Girls)',
                'boys-golf': 'Eastlake Boys Golf Booster Club',
                'girls-golf': 'Eastlake Girls Golf Booster Club',
                'orchestra': 'Eastlake Orchestra Boosters Club',
                'robotics': 'Eastlake Robotics Club',
                'boys-soccer': 'Eastlake Boys Soccer',
                'girls-soccer': 'Eastlake Girls Soccer',
                'boys-swim': 'Eastlake Boys Swim & Dive Booster Club',
                'girls-swim': 'Eastlake Girls Swim & Dive Booster Club',
                'track': 'Eastlake Track and Field Booster Club',
                'volleyball': 'Eastlake Volleyball Booster Club',
                'wrestling': 'Eastlake Wrestling Booster Club'
            };
            return clubNames[clubCode] || clubCode;
        }

        // Update volunteer status
        function updateVolunteerStatus(volunteerId, newStatus) {
            const statusMessages = {
                'contacted': 'Contacted',
                'confirmed': 'Confirmed',
                'declined': 'Declined'
            };

            if (!confirm(`Are you sure you want to mark this volunteer as ${statusMessages[newStatus]}?`)) {
                return;
            }

            fetch(`/api/volunteers/${volunteerId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    status: newStatus
                })
            })
            .then(response => response.json())
                                .then(data => {
                        if (data.success) {
                            alert(`Volunteer status updated to ${statusMessages[newStatus]}`);
                            // Update the stored data and re-display
                            const volunteerIndex = allVolunteerData.findIndex(v => v.id === volunteerId);
                            if (volunteerIndex !== -1) {
                                allVolunteerData[volunteerIndex].status = newStatus;
                                allVolunteerData[volunteerIndex].updatedAt = new Date().toISOString();
                            }
                            displayVolunteerData(allVolunteerData); // Re-display with current filters
                        } else {
                            alert('Error updating volunteer status: ' + data.message);
                        }
                    })
            .catch(error => {
                console.error('Error:', error);
                alert('Error updating volunteer status. Please try again.');
            });
        }

        // View volunteer details
        function viewVolunteerDetails(volunteerId) {
            // For now, just show a simple alert with the volunteer ID
            // In a real application, this would open a modal or navigate to a details page
            alert(`Viewing details for volunteer ID: ${volunteerId}\n\nThis would show detailed information about the volunteer including contact history, notes, etc.`);
        }

        // Export volunteer data to CSV
        function exportVolunteerData() {
            const currentUser = userSession.currentUser || {};
            
            // Get current filter values
            const clubFilter = document.getElementById('volunteerClubFilter').value;
            const statusFilter = document.getElementById('volunteerStatusFilter').value;
            
            // Filter volunteers based on current selections
            let filteredVolunteers = allVolunteerData.filter(volunteer => {
                const clubMatch = !clubFilter || volunteer.boosterClub === clubFilter;
                const statusMatch = !statusFilter || volunteer.status === statusFilter;
                return clubMatch && statusMatch;
            });
            
            if (filteredVolunteers.length === 0) {
                alert('No volunteer data to export. Please check your filters or add some volunteer data first.');
                return;
            }
            
            // Create CSV content
            const headers = ['Name', 'Child Name', 'Email', 'Phone', 'Booster Club', 'Status', 'Submitted Date', 'Notes'];
            const csvContent = [
                headers.join(','),
                ...filteredVolunteers.map(volunteer => [
                    `"${volunteer.name || ''}"`,
                    `"${volunteer.childName || ''}"`,
                    `"${volunteer.email || ''}"`,
                    `"${volunteer.phone || ''}"`,
                    `"${volunteer.boosterClub || ''}"`,
                    `"${volunteer.status || ''}"`,
                    `"${volunteer.submittedAt || ''}"`,
                    `"${volunteer.notes || ''}"`
                ].join(','))
            ].join('\n');
            
            // Create and download the file
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `volunteer_data_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert(`Exported ${filteredVolunteers.length} volunteer records to CSV.`);
        }

        // News Management Functions
        let allNewsData = [];

        async function loadNewsData() {
            try {
                console.log('üì∞ Loading news data...');
                const response = await fetch('/api/news');
                const result = await response.json();
                
                if (result.success) {
                    allNewsData = result.news;
                    displayNewsData(allNewsData);
                } else {
                    console.error('Failed to load news data:', result.message);
                    alert('Failed to load news data: ' + result.message);
                }
            } catch (error) {
                console.error('Error loading news data:', error);
                alert('Error loading news data. Please try again.');
            }
        }

        function displayNewsData(newsData) {
            const tbody = document.querySelector('#news tbody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            if (newsData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4">No news articles found</td></tr>';
                return;
            }
            
            newsData.forEach(news => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${new Date(news.created_at).toLocaleDateString()}</td>
                    <td>${news.title}</td>
                    <td>${news.content.substring(0, 100)}${news.content.length > 100 ? '...' : ''}</td>
                    <td>
                        <button class="btn-small" onclick="editNews('${news.id}')">Edit</button>
                        <button class="btn-small" onclick="deleteNews('${news.id}')">Delete</button>
                        ${news.status === 'draft' ? `<button class="btn-small" onclick="publishNews('${news.id}')">Publish</button>` : ''}
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        async function publishNewsArticle() {
            const title = document.getElementById('newsTitle').value.trim();
            const content = document.getElementById('newsContent').value.trim();
            const date = document.getElementById('newsDate').value;
            
            if (!title || !content) {
                alert('Please fill in both title and content');
                return;
            }
            
            try {
                const response = await fetch('/api/news', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        title: title,
                        content: content,
                        status: 'published',
                        createdBy: userSession.currentUser?.username || 'admin'
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('News article published successfully!');
                    // Clear form
                    document.getElementById('newsTitle').value = '';
                    document.getElementById('newsContent').value = '';
                    document.getElementById('newsDate').value = '';
                    // Reload news data
                    loadNewsData();
                } else {
                    alert('Error publishing news: ' + result.message);
                }
            } catch (error) {
                console.error('Error publishing news:', error);
                alert('Error publishing news. Please try again.');
            }
        }

        async function publishNews(newsId) {
            if (!confirm('Are you sure you want to publish this news article?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/news/${newsId}/publish`, {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('News article published successfully!');
                    loadNewsData();
                } else {
                    alert('Error publishing news: ' + result.message);
                }
            } catch (error) {
                console.error('Error publishing news:', error);
                alert('Error publishing news. Please try again.');
            }
        }

        async function editNews(newsId) {
            // Ensure proper ID comparison (handle UUID strings)
            const news = allNewsData.find(n => String(n.id) === String(newsId));
            if (!news) {
                alert('News article not found');
                console.error('News ID:', newsId, 'Type:', typeof newsId);
                console.error('Available IDs:', allNewsData.map(n => ({ id: n.id, type: typeof n.id })));
                return;
            }
            
            try {
                // Create a modal for editing
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.5);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 1000;
                `;

                modal.innerHTML = `
                    <div style="background: white; padding: 20px; border-radius: 8px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
                        <h3>Edit News Article</h3>
                        <form id="editNewsForm">
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Title *</label>
                                <input type="text" id="editNewsTitle" value="${news.title || ''}" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Content *</label>
                                <textarea id="editNewsContent" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; height: 150px; resize: vertical;">${news.content || ''}</textarea>
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Status</label>
                                <select id="editNewsStatus" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <option value="draft" ${news.status === 'draft' ? 'selected' : ''}>Draft</option>
                                    <option value="published" ${news.status === 'published' ? 'selected' : ''}>Published</option>
                                </select>
                            </div>
                            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                                <button type="button" onclick="closeEditNewsModal()" style="padding: 8px 16px; border: 1px solid #ddd; background: #f8f9fa; border-radius: 4px; cursor: pointer;">Cancel</button>
                                <button type="submit" style="padding: 8px 16px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">Save Changes</button>
                            </div>
                        </form>
                    </div>
                `;

                document.body.appendChild(modal);

                // Handle form submission
                document.getElementById('editNewsForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const formData = {
                        title: document.getElementById('editNewsTitle').value,
                        content: document.getElementById('editNewsContent').value,
                        status: document.getElementById('editNewsStatus').value
                    };

                    try {
                        const response = await fetch(`/api/news/${newsId}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(formData)
                        });

                        const data = await response.json();
                        
                        if (data.success) {
                            alert('News article updated successfully!');
                            closeEditNewsModal();
                            loadNewsData(); // Refresh the data
                        } else {
                            alert('Error updating news: ' + data.message);
                        }
                    } catch (error) {
                        console.error('Error updating news:', error);
                        alert('Error updating news. Please try again.');
                    }
                });

            } catch (error) {
                console.error('Error opening edit modal:', error);
                alert('Error opening edit form. Please try again.');
            }
        }

        // Close edit news modal
        function closeEditNewsModal() {
            const modal = document.querySelector('div[style*="position: fixed"]');
            if (modal) {
                modal.remove();
            }
        }

        async function deleteNews(newsId) {
            if (!confirm('Are you sure you want to delete this news article? This action cannot be undone.')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/news/${newsId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('News article deleted successfully!');
                    loadNewsData();
                } else {
                    alert('Error deleting news: ' + result.message);
                }
            } catch (error) {
                console.error('Error deleting news:', error);
                alert('Error deleting news. Please try again.');
            }
        }

        // Alert function for better user feedback
        function showAlert(message, type = 'info') {
            // Remove existing alerts
            const existingAlerts = document.querySelectorAll('.alert');
            existingAlerts.forEach(alert => alert.remove());
            
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 4px;
                color: white;
                font-weight: bold;
                z-index: 10000;
                max-width: 400px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            `;
            
            // Set background color based on type
            switch(type) {
                case 'success':
                    alertDiv.style.backgroundColor = '#28a745';
                    break;
                case 'danger':
                    alertDiv.style.backgroundColor = '#dc3545';
                    break;
                case 'warning':
                    alertDiv.style.backgroundColor = '#ffc107';
                    alertDiv.style.color = '#212529';
                    break;
                default:
                    alertDiv.style.backgroundColor = '#17a2b8';
            }
            
            alertDiv.textContent = message;
            document.body.appendChild(alertDiv);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        // Links Management Functions
        let allLinksData = [];

        async function loadLinksData() {
            try {
                console.log('üîó Loading links data...');
                const response = await fetch('/api/links');
                const result = await response.json();
                
                if (result.success) {
                    allLinksData = result.links;
                    displayLinksData(allLinksData);
                } else {
                    console.error('Failed to load links data:', result.message);
                    showAlert('Failed to load links data: ' + result.message, 'danger');
                }
            } catch (error) {
                console.error('Error loading links data:', error);
                showAlert('Error loading links data. Please try again.', 'danger');
            }
        }

        function displayLinksData(linksData) {
            const tbody = document.querySelector('#links tbody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            if (linksData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6">No links found</td></tr>';
                return;
            }
            
            linksData.forEach(link => {
                const row = document.createElement('tr');
                const visibilityStatus = link.is_visible ? 
                    '<span class="status-badge status-active">Visible</span>' : 
                    '<span class="status-badge status-inactive">Hidden</span>';
                
                row.innerHTML = `
                    <td>${link.title}</td>
                    <td><a href="${link.url}" target="_blank" rel="noopener noreferrer">${link.url}</a></td>
                    <td><span class="category-badge">${link.category}</span></td>
                    <td>${link.click_count || 0}</td>
                    <td>${visibilityStatus}</td>
                    <td>
                        <button class="btn-small btn-primary" onclick="editLink('${link.id}')">Edit</button>
                        <button class="btn-small btn-danger" onclick="deleteLink('${link.id}')">Delete</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        async function addLink(event) {
            // Prevent default form submission
            if (event) {
                event.preventDefault();
            }
            
            const submitBtn = document.getElementById('addLinkBtn');
            const urlError = document.getElementById('urlError');
            
            // Disable submit button to prevent double submission
            submitBtn.disabled = true;
            submitBtn.textContent = 'Adding...';
            
            // Clear previous error
            urlError.style.display = 'none';
            
            const title = document.getElementById('linkTitle').value.trim();
            const url = document.getElementById('linkUrl').value.trim();
            const category = document.getElementById('linkCategory').value;
            
            // Validate URL format
            try {
                new URL(url);
            } catch (e) {
                urlError.textContent = 'Please enter a valid URL (e.g., https://example.com)';
                urlError.style.display = 'block';
                submitBtn.disabled = false;
                submitBtn.textContent = 'Add Link';
                return;
            }
            
            if (!title || !url) {
                alert('Please fill in both title and URL');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Add Link';
                return;
            }
            
            try {
                const response = await fetch('/api/links', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        title: title,
                        url: url,
                        category: category,
                        createdBy: userSession.currentUser?.username || 'admin'
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert('Link added successfully!', 'success');
                    // Clear form
                    document.getElementById('linkTitle').value = '';
                    document.getElementById('linkUrl').value = '';
                    document.getElementById('linkCategory').value = 'athletics';
                    // Reload links data
                    loadLinksData();
                } else {
                    showAlert('Error adding link: ' + result.message, 'danger');
                }
            } catch (error) {
                console.error('Error adding link:', error);
                showAlert('Error adding link. Please try again.', 'danger');
            } finally {
                // Re-enable submit button
                submitBtn.disabled = false;
                submitBtn.textContent = 'Add Link';
            }
        }

        async function editLink(linkId) {
            const link = allLinksData.find(l => l.id === linkId);
            if (!link) {
                showAlert('Link not found', 'danger');
                return;
            }
            
            // Create edit modal
            const modalHtml = `
                <div id="editLinkModal" class="modal" style="display: block;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>Edit Link</h3>
                            <span class="close" onclick="closeEditLinkModal()">&times;</span>
                        </div>
                        <div class="modal-body">
                            <form id="editLinkForm" onsubmit="updateLink(event, '${link.id}')">
                                <div class="form-group">
                                    <label for="editLinkTitle">Title *</label>
                                    <input type="text" id="editLinkTitle" value="${link.title}" required>
                                </div>
                                <div class="form-group">
                                    <label for="editLinkUrl">URL *</label>
                                    <input type="url" id="editLinkUrl" value="${link.url}" required>
                                    <div id="editUrlError" class="error-message" style="display: none; color: #dc3545; font-size: 12px; margin-top: 5px;"></div>
                                </div>
                                <div class="form-group">
                                    <label for="editLinkCategory">Category</label>
                                    <select id="editLinkCategory">
                                        <option value="athletics" ${link.category === 'athletics' ? 'selected' : ''}>Athletics</option>
                                        <option value="booster" ${link.category === 'booster' ? 'selected' : ''}>Booster Clubs</option>
                                        <option value="community" ${link.category === 'community' ? 'selected' : ''}>Community</option>
                                        <option value="resources" ${link.category === 'resources' ? 'selected' : ''}>Resources</option>
                                        <option value="other" ${link.category === 'other' ? 'selected' : ''}>Other</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="editLinkVisible">Visible</label>
                                    <input type="checkbox" id="editLinkVisible" ${link.is_visible ? 'checked' : ''}>
                                </div>
                                <div class="modal-actions">
                                    <button type="button" onclick="closeEditLinkModal()" class="btn-secondary">Cancel</button>
                                    <button type="submit" id="updateLinkBtn" class="action-btn">Update Link</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal if any
            const existingModal = document.getElementById('editLinkModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Add modal to page
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }
        
        function closeEditLinkModal() {
            const modal = document.getElementById('editLinkModal');
            if (modal) {
                modal.remove();
            }
        }
        
        async function updateLink(event, linkId) {
            event.preventDefault();
            
            const submitBtn = document.getElementById('updateLinkBtn');
            const urlError = document.getElementById('editUrlError');
            
            // Disable submit button
            submitBtn.disabled = true;
            submitBtn.textContent = 'Updating...';
            
            // Clear previous error
            urlError.style.display = 'none';
            
            const title = document.getElementById('editLinkTitle').value.trim();
            const url = document.getElementById('editLinkUrl').value.trim();
            const category = document.getElementById('editLinkCategory').value;
            const isVisible = document.getElementById('editLinkVisible').checked;
            
            // Validate URL format
            try {
                new URL(url);
            } catch (e) {
                urlError.textContent = 'Please enter a valid URL (e.g., https://example.com)';
                urlError.style.display = 'block';
                submitBtn.disabled = false;
                submitBtn.textContent = 'Update Link';
                return;
            }
            
            if (!title || !url) {
                showAlert('Please fill in both title and URL', 'danger');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Update Link';
                return;
            }
            
            try {
                const response = await fetch(`/api/links/${linkId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        title: title,
                        url: url,
                        category: category,
                        isVisible: isVisible
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert('Link updated successfully!', 'success');
                    closeEditLinkModal();
                    loadLinksData();
                } else {
                    showAlert('Error updating link: ' + result.message, 'danger');
                }
            } catch (error) {
                console.error('Error updating link:', error);
                showAlert('Error updating link. Please try again.', 'danger');
            } finally {
                // Re-enable submit button
                submitBtn.disabled = false;
                submitBtn.textContent = 'Update Link';
            }
        }

        async function deleteLink(linkId) {
            if (!confirm('Are you sure you want to delete this link? This action cannot be undone.')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/links/${linkId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert('Link deleted successfully!', 'success');
                    loadLinksData();
                } else {
                    showAlert('Error deleting link: ' + result.message, 'danger');
                }
            } catch (error) {
                console.error('Error deleting link:', error);
                showAlert('Error deleting link. Please try again.', 'danger');
            }
        }
        
        // Session management with timeout
        const SESSION_TIMEOUT = 60 * 60 * 1000; // 1 hour in milliseconds
        const SESSION_EXTENSION_THRESHOLD = 5 * 60 * 1000; // 5 minutes before expiry
        
        function checkSessionTimeout() {
            const loginTime = sessionStorage.getItem('loginTime');
            if (!loginTime) {
                // No login time found, redirect to login
                console.log('No login time found, redirecting to login');
                window.location.href = 'login.html';
                return;
            }
            
            const currentTime = new Date().getTime();
            const timeSinceLogin = currentTime - parseInt(loginTime);
            const timeRemaining = SESSION_TIMEOUT - timeSinceLogin;
            
            console.log(`Session check: ${Math.round(timeRemaining / 1000 / 60)} minutes remaining`);
            
            if (timeSinceLogin > SESSION_TIMEOUT) {
                // Session expired, clear storage and redirect
                console.log('Session expired, clearing storage');
                sessionStorage.clear();
                alert('Your session has expired. Please login again.');
                window.location.href = 'login.html';
                return;
            }
            
            // Only extend session if we're within 5 minutes of expiry
            if (timeSinceLogin > (SESSION_TIMEOUT - SESSION_EXTENSION_THRESHOLD)) {
                console.log('Extending session');
                sessionStorage.setItem('loginTime', currentTime.toString());
            }
        }
        
        // Check session timeout every 5 minutes
        setInterval(checkSessionTimeout, 5 * 60 * 1000);
        

        
        // Demo data loading
        document.addEventListener('DOMContentLoaded', function() {
            // Check if user is logged in using session manager
            if (!userSession.isLoggedIn || !userSession.currentUser) {
                window.location.href = 'login.html';
                return;
            }
            
            // Check session timeout
            checkSessionTimeout();
            
            // Get user data from session manager
            const userData = userSession.currentUser;
            
            // Set up role-based access control
            setupRoleBasedAccess(userData);
            
            // Set up navigation functionality
            setupNavigation();
            
            // Load volunteer data when volunteers section is shown
            document.querySelector('[data-section="volunteers"]').addEventListener('click', function() {
                setTimeout(loadVolunteerData, 100);
            });
            
            // Add event listeners for volunteer filters
            document.getElementById('volunteerClubFilter').addEventListener('change', function() {
                // Re-display current volunteer data with new filter
                displayVolunteerData(allVolunteerData);
            });
            
            document.getElementById('volunteerStatusFilter').addEventListener('change', function() {
                // Re-display current volunteer data with new filter
                displayVolunteerData(allVolunteerData);
            });
            
            // Load news data when news section is shown
            document.querySelector('[data-section="news"]').addEventListener('click', function() {
                setTimeout(loadNewsData, 100);
            });
            
            // Load links data when links section is shown
            document.querySelector('[data-section="links"]').addEventListener('click', function() {
                setTimeout(loadLinksData, 100);
            });
            
            // Add event listeners for news and links buttons
            document.addEventListener('click', function(e) {
                if (e.target.textContent === 'Publish News') {
                    e.preventDefault();
                    publishNewsArticle();
                } else if (e.target.textContent === 'Add Link') {
                    e.preventDefault();
                    addLink();
                }
            });
            
            // Load insurance data when insurance section is shown
            document.querySelector('[data-section="insurance"]').addEventListener('click', function() {
                setTimeout(loadInsuranceData, 100);
            });
            
                    // Load 1099 data when 1099 section is shown
        document.querySelector('[data-section="1099"]').addEventListener('click', function() {
            console.log('üéØ 1099 section clicked, loading data...');
            setTimeout(() => {
                console.log('‚è∞ Loading 1099 data after timeout...');
                load1099Data();
            }, 100);
        });
            
            console.log('Admin dashboard loaded');
            
            // Load dashboard statistics
            loadDashboardStats();
        });
        
        // Load dashboard statistics from API
        async function loadDashboardStats() {
            try {
                console.log('üìä Loading dashboard statistics...');
                
                // Load officers count (real data)
                try {
                    const officersResponse = await fetch('/api/officers');
                    const officersResult = await officersResponse.json();
                    
                    if (officersResult.success) {
                        document.getElementById('totalOfficers').textContent = officersResult.data.length || '0';
                    } else {
                        document.getElementById('totalOfficers').textContent = '0';
                    }
                } catch (error) {
                    console.error('‚ùå Error loading officers:', error);
                    document.getElementById('totalOfficers').textContent = '0';
                }
                
                // Update site visitors with link to Vercel Analytics
                const siteVisitorsElement = document.getElementById('siteVisitors');
                siteVisitorsElement.innerHTML = `
                    <a href="https://vercel.com/dashboard" target="_blank" style="color: #007bff; text-decoration: none;">
                        View Analytics ‚Üí
                    </a>
                `;
                
                // Update top links with simple message
                const topLinksList = document.getElementById('topLinksList');
                topLinksList.innerHTML = `
                    <div class="top-link-item">
                        <span class="top-link-name">Analytics available in Vercel Dashboard</span>
                        <span class="top-link-count">Click "View Analytics" above</span>
                    </div>
                `;
                
                console.log('‚úÖ Dashboard stats loaded with Vercel Analytics integration');
                
            } catch (error) {
                console.error('‚ùå Error loading dashboard stats:', error);
                document.getElementById('totalOfficers').textContent = '0';
                document.getElementById('siteVisitors').textContent = 'N/A';
                document.getElementById('topLinksList').innerHTML = '<div class="top-link-item"><span class="top-link-name">Error loading data</span></div>';
            }
        }
        
        // Set up role-based access control
        function setupRoleBasedAccess(userData) {
            if (userData.role === 'booster_admin') {
                // Hide admin-only sections for booster club admins
                document.querySelectorAll('.admin-only').forEach(el => {
                    el.style.display = 'none';
                });
                
                // Update header to show club name
                const header = document.querySelector('.admin-header h1');
                if (header && userData.clubName) {
                    header.textContent = `EWA Admin Dashboard - ${userData.clubName}`;
                }
                
                // Filter volunteer data to only show their club's volunteers
                // This is handled in the loadVolunteerData function
            } else if (userData.role === 'admin') {
                // Full admin - show all features
                document.querySelectorAll('.admin-only').forEach(el => {
                    el.style.display = 'block';
                });
                
                // Update header for full admin
                const header = document.querySelector('.admin-header h1');
                if (header) {
                    header.textContent = 'EWA Admin Dashboard';
                }
            }
        }
        
        // Submit insurance form
        function submitInsuranceForm(event) {
            // Prevent default form submission
            if (event) {
                event.preventDefault();
            }
            
            const currentUser = userSession.currentUser || {};
            const submitBtn = document.getElementById('submitInsuranceBtn');
            
            // Disable submit button to prevent double submission
            submitBtn.disabled = true;
            submitBtn.textContent = 'Submitting...';
            
            const participantCountInput = document.getElementById('insuranceParticipantCount');
            const boosterClubSelect = document.getElementById('insuranceBoosterClub');
            
            const formData = {
                clubId: boosterClubSelect.value,
                eventName: document.getElementById('insuranceEventName').value,
                eventDate: document.getElementById('insuranceEventDate').value,
                eventDescription: document.getElementById('insuranceEventDescription').value,
                participantCount: participantCountInput.value
            };
            
            if (!formData.clubId || !formData.eventName || !formData.eventDate || !formData.eventDescription) {
                alert('Please fill in all required fields including Booster Club selection');
                // Re-enable submit button
                submitBtn.disabled = false;
                submitBtn.textContent = 'Submit Insurance Form';
                return;
            }
            
            // Validate participant count if provided
            if (formData.participantCount && !validateParticipantCount(participantCountInput)) {
                alert('Please fix the participant count errors before submitting');
                // Re-enable submit button
                submitBtn.disabled = false;
                submitBtn.textContent = 'Submit Insurance Form';
                return;
            }
            
            fetch('/api/insurance', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Insurance form submitted successfully!');
                    // Clear form
                    document.getElementById('insuranceBoosterClub').value = '';
                    document.getElementById('insuranceEventName').value = '';
                    document.getElementById('insuranceEventDate').value = '';
                    document.getElementById('insuranceEventDescription').value = '';
                    document.getElementById('insuranceParticipantCount').value = '';
                    // Reload data
                    loadInsuranceData();
                } else {
                    alert('Error submitting form: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error submitting form. Please try again.');
            })
            .finally(() => {
                // Re-enable submit button
                submitBtn.disabled = false;
                submitBtn.textContent = 'Submit Insurance Form';
            });
        }
        
        // Submit 1099 form
        async function submit1099Form() {
            const currentUser = userSession.currentUser || {};
            const submitBtn = document.getElementById('submit1099Btn');
            const fileInput = document.getElementById('1099W9File');
            
                    // Validate required fields
        const recipientName = document.getElementById('1099RecipientName').value;
        const recipientTin = document.getElementById('1099RecipientTin').value;
        const amountInput = document.getElementById('1099Amount');
        const amount = amountInput.value;
        const boosterClub = document.getElementById('1099BoosterClub').value;
        const taxYear = document.getElementById('1099TaxYear').value;
        
        if (!recipientName || !recipientTin || !amount || !boosterClub || !taxYear) {
            alert('Please fill in all required fields');
            return;
        }
        
        // Validate payment amount
        if (!validatePaymentAmount(amountInput)) {
            alert('Please fix the payment amount errors before submitting');
            return;
        }
            
            if (!fileInput.files[0]) {
                alert('Please select a W9 form file');
                return;
            }
            
            // Disable submit button
            submitBtn.disabled = true;
            submitBtn.textContent = 'Uploading...';
            
            try {
                // First, upload the W9 file
                const file = fileInput.files[0];
                const fileData = await readFileAsBase64(file);
                
                const uploadResponse = await fetch('/api/1099/upload-w9', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        file: fileData,
                        filename: file.name,
                        mimeType: file.type
                    })
                });
                
                const uploadResult = await uploadResponse.json();
                
                if (!uploadResult.success) {
                    throw new Error(uploadResult.message);
                }
                
                // Then submit the 1099 form with W9 file info
                const formData = {
                    recipientName: recipientName,
                    recipientTin: recipientTin,
                    amount: amount,
                    description: document.getElementById('1099Description').value,
                    submittedBy: currentUser.username,
                    boosterClub: boosterClub,
                    taxYear: taxYear,
                    w9Filename: uploadResult.filename,
                    w9BlobUrl: uploadResult.blobUrl,
                    w9FileSize: uploadResult.fileSize,
                    w9MimeType: uploadResult.mimeType
                };
                
                const response = await fetch('/api/1099', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('1099 information submitted successfully!');
                    // Clear form
                    document.getElementById('1099RecipientName').value = '';
                    document.getElementById('1099RecipientTin').value = '';
                    document.getElementById('1099Amount').value = '';
                    document.getElementById('1099Description').value = '';
                    document.getElementById('1099BoosterClub').value = '';
                    document.getElementById('1099TaxYear').value = '';
                    document.getElementById('1099W9File').value = '';
                    document.getElementById('w9FileStatus').innerHTML = '';
                    // Reload data with a small delay to ensure DOM is ready
                    setTimeout(() => {
                        console.log('üîÑ Reloading 1099 data after successful submission...');
                        load1099Data();
                    }, 100);
                } else {
                    alert('Error submitting form: ' + data.message);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error submitting form: ' + error.message);
            } finally {
                // Re-enable submit button
                submitBtn.disabled = false;
                submitBtn.textContent = 'Submit 1099 Information';
            }
        }
        
        // Helper function to read file as base64
        function readFileAsBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const base64 = reader.result.split(',')[1]; // Remove data URL prefix
                    resolve(base64);
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }
        
        // Load insurance data
        function loadInsuranceData() {
            const currentUser = userSession.currentUser || {};
            
            let url = '/api/insurance';
            if (currentUser.role === 'booster_admin' && currentUser.club) {
                url = `/api/insurance/${currentUser.club}`;
            }
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayInsuranceData(data.submissions);
                    } else {
                        console.error('Error loading insurance data:', data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }
        
        // Display insurance data
        function displayInsuranceData(submissions) {
            const tbody = document.querySelector('#insuranceTable tbody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            submissions.forEach(submission => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${new Date(submission.created_at).toLocaleDateString()}</td>
                    <td>${submission.booster_club_name || 'N/A'}</td>
                    <td>${submission.event_name}</td>
                    <td>${new Date(submission.event_date).toLocaleDateString()}</td>
                    <td>${submission.event_description}</td>
                    <td>${submission.participant_count}</td>
                    <td>
                        <select class="status-select" data-id="${submission.id}" onchange="updateInsuranceStatus('${submission.id}', this.value)">
                            <option value="pending" ${submission.status === 'pending' ? 'selected' : ''}>Pending</option>
                            <option value="approved" ${submission.status === 'approved' ? 'selected' : ''}>Approved</option>
                            <option value="rejected" ${submission.status === 'rejected' ? 'selected' : ''}>Rejected</option>
                            <option value="completed" ${submission.status === 'completed' ? 'selected' : ''}>Completed</option>
                        </select>
                    </td>
                    <td>
                        <button class="btn btn-danger btn-sm" onclick="deleteInsuranceSubmission('${submission.id}')">Delete</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // Update insurance submission status
        function updateInsuranceStatus(id, newStatus) {
            fetch(`/api/insurance/${id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ status: newStatus })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('Status updated successfully');
                    // Reload the data to show the updated status
                    loadInsuranceData();
                } else {
                    console.error('Error updating status:', data.message);
                    alert('Error updating status: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error updating status. Please try again.');
            });
        }
        
        // Delete insurance submission
        function deleteInsuranceSubmission(id) {
            if (!confirm('Are you sure you want to delete this insurance submission? This action cannot be undone.')) {
                return;
            }
            
            fetch(`/api/insurance/${id}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('Submission deleted successfully');
                    // Reload the data
                    loadInsuranceData();
                } else {
                    console.error('Error deleting submission:', data.message);
                    alert('Error deleting submission: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error deleting submission. Please try again.');
            });
        }
        
        // Download insurance submissions as CSV
        function downloadInsuranceCSV() {
            fetch('/api/insurance')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.submissions) {
                        const submissions = data.submissions;
                        
                        // Create CSV content
                        const headers = ['Date Submitted', 'Booster Club', 'Event Name', 'Event Date', 'Description', 'Participants', 'Status'];
                        const csvContent = [
                            headers.join(','),
                            ...submissions.map(submission => [
                                new Date(submission.created_at).toLocaleDateString(),
                                submission.booster_club_name || 'N/A',
                                `"${submission.event_name}"`,
                                new Date(submission.event_date).toLocaleDateString(),
                                `"${submission.event_description}"`,
                                submission.participant_count,
                                submission.status
                            ].join(','))
                        ].join('\n');
                        
                        // Create and download file
                        const blob = new Blob([csvContent], { type: 'text/csv' });
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `insurance_submissions_${new Date().toISOString().split('T')[0]}.csv`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        window.URL.revokeObjectURL(url);
                    } else {
                        alert('Error loading data for CSV download');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error downloading CSV. Please try again.');
                });
        }
        
        // Refresh 1099 data with visual feedback
        function refresh1099Data() {
            console.log('üîÑ Manual refresh requested...');
            
            // Get the refresh button
            const refreshBtn = document.getElementById('refresh1099Btn');
            if (refreshBtn) {
                // Show loading state
                refreshBtn.disabled = true;
                refreshBtn.textContent = 'üîÑ Loading...';
                refreshBtn.style.backgroundColor = '#6c757d';
            }
            
            // Call the main load function
            load1099Data();
            
            // Re-enable button after a short delay
            setTimeout(() => {
                if (refreshBtn) {
                    refreshBtn.disabled = false;
                    refreshBtn.textContent = 'üîÑ Refresh Submissions';
                    refreshBtn.style.backgroundColor = '#007bff';
                }
            }, 2000);
        }
        
        // Load 1099 data - COMPLETELY REWRITTEN
        function load1099Data() {
            console.log('üöÄ Starting 1099 data load...');
            
            // Get current user
            const currentUser = userSession.currentUser || {};
            console.log('üë§ Current user:', currentUser);
            
            // Determine API URL based on user role
            let url = '/api/1099';
            if (currentUser.role === 'booster_admin' && currentUser.club) {
                url = `/api/1099/${currentUser.club}`;
            }
            
            console.log('üåê Making API request to:', url);
            
            // Add more debugging
            console.log('üîç Current window location:', window.location.href);
            console.log('üîç Full API URL will be:', window.location.origin + url);
            
            // Show loading state - with better error handling
            let tbody = null;
            try {
                console.log('üîç Looking for 1099Table tbody element...');
                const table = document.getElementById('1099Table');
                console.log('üîç Found table element:', table);
                if (table) {
                    tbody = table.querySelector('tbody');
                    console.log('üîç Found tbody via table:', tbody);
                }
            } catch (error) {
                console.error('‚ùå Error finding tbody:', error);
            }
            
            if (tbody) {
                tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; padding: 20px;">Loading 1099 submissions...</td></tr>';
            } else {
                console.error('‚ùå Could not find 1099Table tbody element - table may not be loaded yet');
                // Try again after a short delay
                setTimeout(() => {
                    console.log('üîÑ Retrying load1099Data after delay...');
                    load1099Data();
                }, 500);
                return;
            }
            
            // Make API request
            console.log('üì° About to make fetch request to:', url);
            fetch(url, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => {
                console.log('üì° API Response status:', response.status);
                console.log('üì° API Response headers:', response.headers);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                return response.json();
            })
            .then(data => {
                console.log('üìä API Response data:', data);
                
                if (data && data.success) {
                    console.log('‚úÖ API call successful, submissions count:', data.submissions ? data.submissions.length : 0);
                    // Store submissions for filtering
                    window.current1099Submissions = data.submissions || [];
                    display1099Data(window.current1099Submissions);
                } else {
                    console.error('‚ùå API returned error:', data);
                    display1099Data([]);
                    showErrorMessage('Failed to load 1099 data: ' + (data.message || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('üí• Fetch error:', error);
                display1099Data([]);
                showErrorMessage('Network error loading 1099 data: ' + error.message);
            });
        }
        
        // Display 1099 data - COMPLETELY REWRITTEN
        function display1099Data(submissions) {
            console.log('üé® Starting to display 1099 data...');
            console.log('üìã Submissions to display:', submissions);
            
            // Initialize export buttons
            updateExportButtons();
            
            // Find the table body with error handling
            let tbody = null;
            try {
                const table = document.getElementById('1099Table');
                if (table) {
                    tbody = table.querySelector('tbody');
                }
            } catch (error) {
                console.error('‚ùå Error finding tbody in display1099Data:', error);
            }
            
            if (!tbody) {
                console.error('‚ùå Could not find 1099Table tbody element');
                showErrorMessage('Could not find 1099 table element');
                return;
            }
            
            console.log('‚úÖ Found table body, clearing existing content');
            tbody.innerHTML = '';
            
            // Check if we have submissions
            if (!submissions || submissions.length === 0) {
                console.log('üì≠ No submissions to display');
                tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; padding: 20px; color: #666;">No 1099 submissions found</td></tr>';
                return;
            }
            
            console.log(`üìù Processing ${submissions.length} submissions...`);
            
            // Process each submission
            submissions.forEach((submission, index) => {
                console.log(`üìÑ Processing submission ${index + 1}:`, submission);
                
                try {
                    // Create W9 link
                    const w9Link = submission.w9_blob_url ? 
                        `<a href="${submission.w9_blob_url}" target="_blank" class="file-link">View W9</a>` : 
                        '<span class="no-file">No W9 uploaded</span>';
                    
                    // Format date
                    const formattedDate = submission.created_at ? 
                        new Date(submission.created_at).toLocaleDateString() : 
                        'N/A';
                    
                    // Format amount
                    const formattedAmount = submission.amount ? 
                        `$${parseFloat(submission.amount).toFixed(2)}` : 
                        'N/A';
                    
                    // Get booster club display name
                    const boosterClubDisplay = getBoosterClubDisplayName(submission.booster_club);
                    
                    // Create status dropdown
                    const statusOptions = ['pending', 'acknowledged', 'submitted_to_irs'];
                    const statusSelect = `
                        <select onchange="update1099Status('${submission.id}', this.value)" style="padding: 2px; border: 1px solid #ddd; border-radius: 3px;">
                            ${statusOptions.map(status => 
                                `<option value="${status}" ${submission.status === status ? 'selected' : ''}>
                                    ${status.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())}
                                </option>`
                            ).join('')}
                        </select>
                    `;
                    
                    // Create table row
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><input type="checkbox" class="checkbox-1099" value="${submission.id}" onchange="updateExportButtons()"></td>
                        <td>${formattedDate}</td>
                        <td>${submission.recipient_name || 'N/A'}</td>
                        <td>${submission.recipient_tin || 'N/A'}</td>
                        <td>${formattedAmount}</td>
                        <td>${submission.tax_year || 'N/A'}</td>
                        <td>${boosterClubDisplay}</td>
                        <td>${w9Link}</td>
                        <td>${statusSelect}</td>
                        <td>
                            <button onclick="edit1099Submission('${submission.id}')" class="action-btn-small" style="background-color: #28a745; color: white; padding: 2px 8px; font-size: 12px; border: none; border-radius: 3px; cursor: pointer; margin-right: 5px;">
                                Edit
                            </button>
                            <button onclick="delete1099Submission('${submission.id}', '${submission.recipient_name || 'Unknown'}')" class="action-btn-small" style="background-color: #dc3545; color: white; padding: 2px 8px; font-size: 12px; border: none; border-radius: 3px; cursor: pointer;">
                                Delete
                            </button>
                        </td>
                    `;
                    
                    tbody.appendChild(row);
                    console.log(`‚úÖ Added row for ${submission.recipient_name || 'Unknown'}`);
                    
                } catch (error) {
                    console.error(`‚ùå Error processing submission ${index + 1}:`, error);
                }
            });
            
            console.log('üéâ Finished displaying 1099 data');
            
            // Update export buttons after all data is displayed
            updateExportButtons();
        }
        
        // Helper function to show error messages
        function showErrorMessage(message) {
            console.error('üö® Error:', message);
            
            // Try to show error in the table with error handling
            let tbody = null;
            try {
                const table = document.getElementById('1099Table');
                if (table) {
                    tbody = table.querySelector('tbody');
                }
            } catch (error) {
                console.error('‚ùå Error finding tbody in showErrorMessage:', error);
            }
            
            if (tbody) {
                tbody.innerHTML = `<tr><td colspan="7" style="text-align: center; padding: 20px; color: red;">Error: ${message}</td></tr>`;
            }
            
            // Also show alert for immediate feedback
            alert('Error: ' + message);
        }
        
        // Security Settings Functions
        
        // Check if user needs first login setup
        function checkFirstLogin() {
            const currentUser = JSON.parse(sessionStorage.getItem('currentUser') || '{}');
            if (currentUser.isFirstLogin) {
                document.getElementById('firstLoginSetup').style.display = 'block';
            }
        }
        
        // Change password
        function changePassword() {
            const currentUser = userSession.currentUser || {};
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPasswordProfile').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (!currentPassword || !newPassword || !confirmPassword) {
                alert('Please fill in all fields');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                alert('New passwords do not match');
                return;
            }
            
            fetch('/api/users/change-password', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    username: currentUser.username,
                    currentPassword,
                    newPassword
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Password changed successfully');
                    // Clear form
                    document.getElementById('currentPassword').value = '';
                    document.getElementById('newPasswordProfile').value = '';
                    document.getElementById('confirmPassword').value = '';
                } else {
                    alert('Error changing password: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error changing password. Please try again.');
            });
        }
        
        // Setup profile (first login)
        function setupProfile() {
            const currentUser = JSON.parse(sessionStorage.getItem('currentUser') || '{}');
            const secretQuestion = document.getElementById('secretQuestion').value.trim();
            const secretAnswer = document.getElementById('secretAnswer').value.trim();
            
            if (!secretQuestion || !secretAnswer) {
                alert('Please fill in both secret question and answer');
                return;
            }
            
            fetch('/api/users/setup-profile', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    username: currentUser.username,
                    secretQuestion,
                    secretAnswer
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Profile setup completed successfully');
                    document.getElementById('firstLoginSetup').style.display = 'none';
                    // Update session storage
                    currentUser.isFirstLogin = false;
                    sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
                } else {
                    alert('Error setting up profile: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error setting up profile. Please try again.');
            });
        }
        
        // Get secret question for forgot password
        function getSecretQuestion() {
            const username = document.getElementById('forgotUsername').value.trim();
            
            if (!username) {
                alert('Please enter your username');
                return;
            }
            
            fetch(`/api/users/${username}/secret-question`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('secretQuestionLabel').textContent = data.secretQuestion;
                        document.getElementById('secretQuestionSection').style.display = 'block';
                    } else {
                        alert('Error: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error getting secret question. Please try again.');
                });
        }
        
        // Reset password using secret answer
        function resetPassword() {
            const username = document.getElementById('forgotUsername').value.trim();
            const secretAnswer = document.getElementById('secretQuestionAnswer').value.trim();
            const newPassword = document.getElementById('newPasswordForgot').value;
            const confirmPassword = document.getElementById('confirmPasswordForgot').value;
            
            if (!username || !secretAnswer || !newPassword || !confirmPassword) {
                alert('Please fill in all fields');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                alert('New passwords do not match');
                return;
            }
            
            fetch('/api/users/forgot-password', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    username,
                    secretAnswer,
                    newPassword
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Password reset successfully');
                    // Clear form
                    document.getElementById('forgotUsername').value = '';
                    document.getElementById('secretQuestionAnswer').value = '';
                    document.getElementById('newPasswordForgot').value = '';
                    document.getElementById('confirmPasswordForgot').value = '';
                    document.getElementById('secretQuestionSection').style.display = 'none';
                } else {
                    alert('Error resetting password: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error resetting password. Please try again.');
            });
        }
        
        // User Management Functions
        
        // Load users data
        function loadUsersData() {
            fetch('/api/users')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayUsersData(data.users);
                    } else {
                        console.error('Error loading users:', data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }
        
        // Display users data
        function displayUsersData(users) {
            const tbody = document.getElementById('usersTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            Object.values(users).forEach(user => {
                const row = document.createElement('tr');
                const status = user.isLocked ? 'Locked' : 'Active';
                const statusClass = user.isLocked ? 'status-inactive' : 'status-active';
                const lastLogin = user.lastLogin ? new Date(user.lastLogin).toLocaleString() : 'Never';
                
                row.innerHTML = `
                    <td>${user.username}</td>
                    <td>${user.role === 'admin' ? 'Admin' : 'Booster Club Admin'}</td>
                    <td>${user.clubName || '-'}</td>
                    <td><span class="${statusClass}">${status}</span></td>
                    <td>${lastLogin}</td>
                    <td>
                        <button class="btn-small" onclick="editUser('${user.username}')">Edit</button>
                        <button class="btn-small" onclick="toggleUserLock('${user.username}', ${user.isLocked})">${user.isLocked ? 'Unlock' : 'Lock'}</button>
                        <button class="btn-small" onclick="resetUserPassword('${user.username}')">Reset Password</button>
                        <button class="btn-small btn-danger" onclick="deleteUser('${user.username}')">Delete</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // Add new user
        function addUser() {
            const username = document.getElementById('newUsername').value.trim();
            const password = document.getElementById('newPassword').value;
            const role = document.getElementById('userRole').value;
            const club = document.getElementById('userClub').value;
            
            if (!username || !password || !role) {
                alert('Please fill in all required fields');
                return;
            }
            
            if (role === 'booster_admin' && !club) {
                alert('Please select a club for Booster Club Admin');
                return;
            }
            
            const clubName = role === 'booster_admin' ? document.getElementById('userClub').options[document.getElementById('userClub').selectedIndex].text : '';
            
            fetch('/api/users', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    username,
                    password,
                    role,
                    club,
                    clubName
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('User created successfully');
                    // Clear form
                    document.getElementById('newUsername').value = '';
                    document.getElementById('newPassword').value = '';
                    document.getElementById('userRole').value = 'admin';
                    document.getElementById('userClub').value = '';
                    // Reload users
                    loadUsersData();
                } else {
                    alert('Error creating user: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error creating user. Please try again.');
            });
        }
        
        // Edit user
        function editUser(username) {
            const newUsername = prompt('Enter new username (leave empty to keep current):');
            if (newUsername === null) return;
            
            const newPassword = prompt('Enter new password (leave empty to keep current):');
            if (newPassword === null) return;
            
            const updateData = {};
            if (newUsername) updateData.newUsername = newUsername;
            if (newPassword) updateData.password = newPassword;
            
            if (Object.keys(updateData).length === 0) {
                alert('No changes made');
                return;
            }
            
            fetch(`/api/users/${username}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(updateData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('User updated successfully');
                    loadUsersData();
                } else {
                    alert('Error updating user: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error updating user. Please try again.');
            });
        }
        
        // Toggle user lock
        function toggleUserLock(username, currentLocked) {
            const action = currentLocked ? 'unlock' : 'lock';
            if (!confirm(`Are you sure you want to ${action} user "${username}"?`)) return;
            
            fetch(`/api/users/${username}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    isLocked: !currentLocked
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`User ${action}ed successfully`);
                    loadUsersData();
                } else {
                    alert('Error updating user: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error updating user. Please try again.');
            });
        }
        
        // Reset user password
        function resetUserPassword(username) {
            const newPassword = prompt('Enter new password:');
            if (!newPassword) return;
            
            fetch(`/api/users/${username}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    password: newPassword
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Password reset successfully');
                    loadUsersData();
                } else {
                    alert('Error resetting password: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error resetting password. Please try again.');
            });
        }
        
        // Delete user
        function deleteUser(username) {
            if (!confirm(`Are you sure you want to delete user "${username}"? This action cannot be undone.`)) return;
            
            fetch(`/api/users/${username}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('User deleted successfully');
                    loadUsersData();
                } else {
                    alert('Error deleting user: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error deleting user. Please try again.');
            });
        }
        
        // Officer Management Functions
        
        // Load officers data
        function loadOfficersData() {
            const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
            let url = '/api/officers';
            
            // If user is booster_admin, only show their club's officers
            if (currentUser.role === 'booster_admin' && currentUser.club) {
                url = `/api/officers/${currentUser.club}`;
            }
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayOfficersData(data.officers);
                    } else {
                        console.error('Error loading officers:', data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }
        
        // Display officers data in table
        function displayOfficersData(officers) {
            const tbody = document.getElementById('officersTableBody');
            tbody.innerHTML = '';
            
            // Store officers data for edit functionality
            window.currentOfficers = officers;
            
            if (officers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">No officers found</td></tr>';
                return;
            }
            
            officers.forEach(officer => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${officer.name}</td>
                    <td>${officer.position}</td>
                    <td>${officer.boosterclubname || 'No club assigned'}</td>
                    <td>${officer.email}</td>
                    <td>${officer.phone}</td>
                    <td>
                        <button class="btn-small" onclick="editOfficer('${officer.id}')">Edit</button>
                        <button class="btn-small btn-danger" onclick="deleteOfficer('${officer.id}')">Delete</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // Add new officer
        function addOfficer() {
            const name = document.getElementById('officerName').value.trim();
            const position = document.getElementById('officerPosition').value.trim();
            const email = document.getElementById('officerEmail').value.trim();
            let phone = document.getElementById('officerPhone').value.trim();
            const clubSelect = document.getElementById('boosterClub');
            const booster_club = clubSelect.options[clubSelect.selectedIndex].text;
            
            // Format blank phone as "000-000-0000"
            if (!phone) {
                phone = "000-000-0000";
            }
            
            if (!name || !position || !email || !booster_club) {
                alert('Please fill in all required fields (Name, Position, Email, and Booster Club)');
                return;
            }
            
            fetch('/api/officers', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    name,
                    position,
                    email,
                    phone,
                    booster_club
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Officer added successfully');
                    // Clear form
                    document.getElementById('officerName').value = '';
                    document.getElementById('officerPosition').value = '';
                    document.getElementById('officerEmail').value = '';
                    document.getElementById('officerPhone').value = '';
                    document.getElementById('boosterClub').value = '';
                    loadOfficersData();
                } else {
                    alert('Error adding officer: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error adding officer. Please try again.');
            });
        }
        
        // Create new booster club
        async function createNewBoosterClub() {
            const name = document.getElementById('newClubName').value.trim();
            
            if (!name) {
                alert('Please enter a club name');
                return;
            }
            
            try {
                const response = await fetch('/api/booster-clubs', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        name: name
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('Booster club created successfully! You can now configure description, website, and payment settings using the existing admin tools.');
                    // Clear form
                    document.getElementById('newClubName').value = '';
                    // Refresh club lists
                    loadBoosterClubs();
                } else {
                    alert('Error: ' + result.message);
                }
            } catch (error) {
                console.error('Error creating booster club:', error);
                alert('Failed to create booster club. Please try again.');
            }
        }
        
        // Edit officer
        function editOfficer(id) {
            // Find the officer data from the current display
            const officers = window.currentOfficers || [];
            const officer = officers.find(o => o.id === id);
            
            if (!officer) {
                showAlert('Officer not found', 'danger');
                return;
            }
            
            // Populate the main form with officer data
            document.getElementById('officerName').value = officer.name || '';
            document.getElementById('officerPosition').value = officer.position || '';
            document.getElementById('officerEmail').value = officer.email || '';
            document.getElementById('officerPhone').value = officer.phone || '';
            
            // Set the club in the dropdown
            const clubSelect = document.getElementById('boosterClub');
            if (clubSelect) {
                clubSelect.value = officer.boosterclubname || '';
            }
            
            // Change the button text and action
            const addButton = document.querySelector('button[onclick="addOfficer()"]');
            if (addButton) {
                addButton.textContent = 'Update Officer';
                addButton.onclick = () => updateOfficerFromForm(id);
            }
            
            // Show the cancel button
            document.getElementById('cancelOfficerEdit').style.display = 'inline-block';
            
            // Scroll to the form
            document.getElementById('officers').scrollIntoView({ behavior: 'smooth' });
            
            // Show a brief message to indicate the officer was selected for editing
            showAlert(`Editing officer: ${officer.name}`, 'info');
        }
        
        // Show edit officer modal
        function showEditOfficerModal(officer) {
            // Create modal HTML
            const modalHTML = `
                <div id="editOfficerModal" class="modal" style="display: block;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>Edit Officer</h3>
                            <span class="close" onclick="closeEditOfficerModal()">&times;</span>
                        </div>
                        <div class="modal-body">
                            <form id="editOfficerForm">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="editOfficerName">Name</label>
                                        <input type="text" id="editOfficerName" value="${officer.name}" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="editOfficerPosition">Position</label>
                                        <input type="text" id="editOfficerPosition" value="${officer.position}" required>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="editOfficerEmail">Email *</label>
                                        <input type="email" id="editOfficerEmail" value="${officer.email}" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="editOfficerPhone">Phone (optional)</label>
                                        <input type="tel" id="editOfficerPhone" value="${officer.phone}">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="editOfficerClub">Booster Club</label>
                                    <select id="editOfficerClub" required>
                                        <option value="">Select Booster Club</option>
                                        <!-- Clubs will be loaded dynamically from database -->
                                    </select>
                                </div>
                                <div class="form-actions">
                                    <button type="button" onclick="closeEditOfficerModal()" class="btn-secondary">Cancel</button>
                                    <button type="submit" class="action-btn">Update Officer</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;
            
            // Add modal to page
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Populate the dropdown with clubs from database
            const clubSelect = document.getElementById('editOfficerClub');
            if (clubSelect && allBoosterClubs.length > 0) {
                // Keep the first "Select" option
                const firstOption = clubSelect.querySelector('option');
                clubSelect.innerHTML = '';
                if (firstOption) {
                    clubSelect.appendChild(firstOption);
                }
                
                // Add clubs from database
                allBoosterClubs.forEach(club => {
                    const option = document.createElement('option');
                    option.value = club.name;
                    option.textContent = club.name;
                    clubSelect.appendChild(option);
                });
                
                // Set the current club value
                clubSelect.value = officer.boosterclubname || '';
            }
            
            // Add form submit handler
            document.getElementById('editOfficerForm').addEventListener('submit', function(e) {
                e.preventDefault();
                updateOfficerData(officer.id);
            });
        }
        
        // Update officer from main form
        async function updateOfficerFromForm(officerId) {
            const name = document.getElementById('officerName').value.trim();
            const position = document.getElementById('officerPosition').value.trim();
            const email = document.getElementById('officerEmail').value.trim();
            const phone = document.getElementById('officerPhone').value.trim();
            const boosterClub = document.getElementById('boosterClub').value;

            if (!name || !position || !email || !boosterClub) {
                showAlert('Please fill in all required fields', 'warning');
                return;
            }

            try {
                const response = await fetch(`/api/officers/${officerId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name,
                        position,
                        email,
                        phone,
                        boosterclubname: boosterClub
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    showAlert('Officer updated successfully!', 'success');
                    cancelOfficerEdit(); // Reset the form
                    loadOfficersData(); // Refresh the table
                } else {
                    showAlert('Failed to update officer: ' + data.message, 'danger');
                }
            } catch (error) {
                console.error('Error updating officer:', error);
                showAlert('Error updating officer', 'danger');
            }
        }

        // Cancel officer edit and reset form
        function cancelOfficerEdit() {
            // Clear the form
            document.getElementById('officerName').value = '';
            document.getElementById('officerPosition').value = '';
            document.getElementById('officerEmail').value = '';
            document.getElementById('officerPhone').value = '';
            document.getElementById('boosterClub').value = '';
            
            // Reset the button
            const addButton = document.querySelector('button[onclick*="updateOfficerFromForm"]');
            if (addButton) {
                addButton.textContent = 'Add Officer';
                addButton.onclick = addOfficer;
            }
            
            // Hide the cancel button
            document.getElementById('cancelOfficerEdit').style.display = 'none';
        }

        // Close edit officer modal
        function closeEditOfficerModal() {
            const modal = document.getElementById('editOfficerModal');
            if (modal) {
                modal.remove();
            }
        }
        
        // Update officer data
        function updateOfficerData(id) {
            const name = document.getElementById('editOfficerName').value.trim();
            const position = document.getElementById('editOfficerPosition').value.trim();
            const email = document.getElementById('editOfficerEmail').value.trim();
            let phone = document.getElementById('editOfficerPhone').value.trim();
            const clubSelect = document.getElementById('editOfficerClub');
            const booster_club = clubSelect.options[clubSelect.selectedIndex].text;
            
            // Format blank phone as "000-000-0000"
            if (!phone) {
                phone = "000-000-0000";
            }
            
            if (!name || !position || !email || !booster_club) {
                alert('Please fill in all required fields (Name, Position, Email, and Booster Club)');
                return;
            }
            
            fetch(`/api/officers/${id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    name,
                    position,
                    email,
                    phone,
                    booster_club
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Officer updated successfully');
                    closeEditOfficerModal();
                    loadOfficersData();
                } else {
                    alert('Error updating officer: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error updating officer. Please try again.');
            });
        }
        
        // Delete officer
        function deleteOfficer(id) {
            if (!confirm('Are you sure you want to delete this officer? This action cannot be undone.')) return;
            
            fetch(`/api/officers/${id}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Officer deleted successfully');
                    loadOfficersData();
                } else {
                    alert('Error deleting officer: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error deleting officer. Please try again.');
            });
        }
        
        // Download officer import template
        function downloadOfficerTemplate() {
            window.open('/api/officers/template', '_blank');
        }
        
        // Import officer data from CSV
        function importOfficerData() {
            const fileInput = document.getElementById('spreadsheet');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Please select a file to import.');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const csv = e.target.result;
                const lines = csv.split('\n');
                const headers = lines[0].split(',').map(h => h.trim());
                
                // Validate headers
                const requiredHeaders = ['name', 'position', 'email', 'phone', 'booster_club'];
                const missingHeaders = requiredHeaders.filter(h => !headers.includes(h));
                
                if (missingHeaders.length > 0) {
                    alert('Invalid CSV format. Missing headers: ' + missingHeaders.join(', '));
                    return;
                }
                
                let successCount = 0;
                let errorCount = 0;
                
                // Process each line (skip header)
                for (let i = 1; i < lines.length; i++) {
                    if (lines[i].trim() === '') continue;
                    
                    const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
                    const officerData = {
                        name: values[0],
                        position: values[1],
                        email: values[2],
                        phone: values[3],
                        booster_club: values[4]
                    };
                    
                    // Validate required fields
                    if (!officerData.name || !officerData.position || !officerData.email || !officerData.phone || !officerData.booster_club) {
                        errorCount++;
                        continue;
                    }
                    
                    // Submit officer data
                    fetch('/api/officers', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(officerData)
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            successCount++;
                        } else {
                            errorCount++;
                        }
                        
                        // If this is the last line, show results
                        if (i === lines.length - 1) {
                            alert(`Import completed. Success: ${successCount}, Errors: ${errorCount}`);
                            loadOfficersData();
                            fileInput.value = '';
                        }
                    })
                    .catch(error => {
                        errorCount++;
                        console.error('Error importing officer:', error);
                    });
                }
            };
            reader.readAsText(file);
        }
        
        // Website link management
        const websiteLinks = [
            { club: 'Eastlake Band Boosters', url: 'https://ehsbandboosters.org', enabled: true },
            { club: 'Eastlake Baseball Club', url: 'https://eastlakebaseball.org', enabled: true },
            { club: 'Eastlake Boys Basketball Booster Club', url: 'https://eastlakeboysbasketball.org', enabled: true },
            { club: 'Eastlake Girls Basketball Booster Club', url: 'https://eastlakegirlsbasketball.org', enabled: true },
            { club: 'Eastlake Cheer Booster Club', url: 'https://eastlakecheer.org', enabled: true },
            { club: 'Eastlake Choir', url: 'https://eastlakechoir.org', enabled: true },
            { club: 'Eastlake Cross-Country Boosters', url: 'https://eastlakecrosscountry.org', enabled: true },
            { club: 'Eastlake Dance Team Boosters', url: 'https://eastlakedanceteam.org', enabled: true },
            { club: 'Eastlake DECA Booster Club', url: 'https://ehsdeca.org', enabled: true },
            { club: 'Eastlake Drama Boosters', url: 'https://eastlakedrama.org', enabled: true },
            { club: 'Eastlake Fastpitch (Girls)', url: 'https://eastlakefastpitch.org', enabled: true },
            { club: 'Eastlake Boys Golf Booster Club', url: 'https://eastlakeboysgolf.org', enabled: true },
            { club: 'Eastlake Girls Golf Booster Club', url: 'https://eastlakegirlsgolf.org', enabled: true },
            { club: 'Eastlake Orchestra Boosters Club', url: 'https://ehsorchestra.org', enabled: true },
            { club: 'Eastlake Robotics Club', url: 'https://eastlakerobotics.org', enabled: true },
            { club: 'Eastlake Boys Soccer', url: 'https://eastlakeboyssoccer.org', enabled: true },
            { club: 'Eastlake Girls Soccer', url: 'https://eastlakegirlssoccer.org', enabled: true },
            { club: 'Eastlake Boys Swim & Dive Booster Club', url: 'https://eastlakeboysswim.org', enabled: true },
            { club: 'Eastlake Girls Swim & Dive Booster Club', url: 'https://eastlakegirlsswim.org', enabled: true },
            { club: 'Eastlake Track and Field Booster Club', url: 'https://ehstrackandfield.org', enabled: true },
            { club: 'Eastlake Volleyball Booster Club', url: 'https://eastlakevolleyball.org', enabled: true },
            { club: 'Eastlake Wrestling Booster Club', url: 'https://ehswrestling.org', enabled: true }
        ];
        
        async function updateWebsiteLink() {
            const clubSelect = document.getElementById('websiteClubSelect');
            const urlInput = document.getElementById('websiteUrl');
            const enabledCheckbox = document.getElementById('websiteEnabled');
            
            const selectedClub = clubSelect.value;
            const newUrl = urlInput.value.trim();
            const enabled = enabledCheckbox.checked;
            
            if (!selectedClub) {
                showAlert('Please select a club.', 'warning');
                return;
            }
            
            if (!newUrl) {
                showAlert('Please enter a website URL.', 'warning');
                return;
            }
            
            try {
                // Call the API to update the website URL
                const response = await fetch(`/api/booster-clubs/${encodeURIComponent(selectedClub)}/website`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ websiteUrl: newUrl })
                });

                const result = await response.json();

                if (result.success) {
                    // Update the local array
                    const linkIndex = websiteLinks.findIndex(link => link.club === selectedClub);
                    if (linkIndex !== -1) {
                        websiteLinks[linkIndex].url = newUrl;
                        websiteLinks[linkIndex].enabled = enabled;
                    } else {
                        websiteLinks.push({
                            club: selectedClub,
                            url: newUrl,
                            enabled: enabled
                        });
                    }
                    
                    // Update the display
                    displayWebsiteLinks();
                    
                    showAlert('Website link updated successfully!', 'success');
                    
                    // Clear form
                    urlInput.value = '';
                    enabledCheckbox.checked = true;
                } else {
                    showAlert('Failed to update website link: ' + result.message, 'danger');
                }
            } catch (error) {
                console.error('Error updating website link:', error);
                showAlert('Error updating website link', 'danger');
            }
        }
        
        function displayWebsiteLinks() {
            const tbody = document.getElementById('websiteLinksTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = websiteLinks.map(link => `
                <tr>
                    <td>${link.club}</td>
                    <td><a href="${link.url}" target="_blank">${link.url}</a></td>
                    <td><span class="status-${link.enabled ? 'active' : 'inactive'}">${link.enabled ? 'Active' : 'Disabled'}</span></td>
                    <td>
                        <button class="btn-small" onclick="editWebsiteLink('${link.club}')">Edit</button>
                        <button class="btn-small" onclick="toggleWebsiteLink('${link.club}', ${link.enabled})">${link.enabled ? 'Disable' : 'Enable'}</button>
                    </td>
                </tr>
            `).join('');
        }
        
        function editWebsiteLink(clubName) {
            const link = websiteLinks.find(l => l.club === clubName);
            if (!link) return;
            
            const clubSelect = document.getElementById('websiteClubSelect');
            const urlInput = document.getElementById('websiteUrl');
            const enabledCheckbox = document.getElementById('websiteEnabled');
            
            clubSelect.value = clubName;
            urlInput.value = link.url;
            enabledCheckbox.checked = link.enabled;
            
            // Scroll to the form
            document.getElementById('club-websites').scrollIntoView({ behavior: 'smooth' });
            
            // Show a brief message to indicate the club was selected for editing
            showAlert(`Editing website link for ${clubName}`, 'info');
        }
        
        function toggleWebsiteLink(clubName, currentStatus) {
            const link = websiteLinks.find(l => l.club === clubName);
            if (!link) return;
            
            link.enabled = !currentStatus;
            displayWebsiteLinks();
            
            showAlert(`Website link for ${clubName} has been ${link.enabled ? 'enabled' : 'disabled'}.`, 'success');
        }

        // Load website links from database
        async function loadWebsiteLinks() {
            try {
                console.log('Loading website links from database...');
                const response = await fetch('/api/booster-clubs');
                const result = await response.json();

                if (result.success) {
                    console.log('Received data from API:', result.data.length, 'clubs');
                    // Update the websiteLinks array with data from database
                    websiteLinks.length = 0; // Clear the array
                    result.data.forEach(club => {
                        if (club.website_url && club.website_url.trim() !== '') {
                            websiteLinks.push({
                                club: club.name,
                                url: club.website_url,
                                enabled: club.is_active !== false // Default to true if not specified
                            });
                        }
                    });
                    
                    console.log('Updated websiteLinks array:', websiteLinks.length, 'entries');
                    // Update the display
                    displayWebsiteLinks();
                } else {
                    console.error('API returned error:', result);
                    showAlert('Failed to load website links: ' + (result.message || 'Unknown error'), 'danger');
                }
            } catch (error) {
                console.error('Error loading website links:', error);
                showAlert('Error loading website links: ' + error.message, 'danger');
            }
        }
        
        // Add event listener for users section
        document.addEventListener('DOMContentLoaded', function() {
            // ... existing code ...
            
            // Check for first login setup
            checkFirstLogin();
            
            // Add event listener for users section
            const usersLink = document.querySelector('a[data-section="users"]');
            if (usersLink) {
                usersLink.addEventListener('click', function() {
                    loadUsersData();
                });
            }
            
            // Add event listener for profile section
            const profileLink = document.querySelector('a[data-section="profile"]');
            if (profileLink) {
                profileLink.addEventListener('click', function() {
                    checkFirstLogin();
                });
            }
            
            // Add event listener for officers section
            const officersLink = document.querySelector('a[data-section="officers"]');
            if (officersLink) {
                officersLink.addEventListener('click', function() {
                    loadOfficersData();
                });
            }
            
            // Add event listener for website links section
            const websiteLinksLink = document.querySelector('a[data-section="club-websites"]');
            if (websiteLinksLink) {
                websiteLinksLink.addEventListener('click', function() {
                    displayWebsiteLinks();
                });
            }
            
                    // Initialize website links display
        displayWebsiteLinks();
        
    });
    
    
    // Payment amount validation function
    function validatePaymentAmount(input) {
        const value = input.value;
        const errorDiv = document.getElementById('amountError');
        
        // Clear previous error
        errorDiv.style.display = 'none';
        
        // Check if empty
        if (!value) {
            return true; // Let HTML5 validation handle required field
        }
        
        // Check if it's a valid number
        const numValue = parseFloat(value);
        if (isNaN(numValue)) {
            errorDiv.textContent = 'Please enter a valid number';
            errorDiv.style.display = 'block';
            return false;
        }
        
        // Check if it's negative
        if (numValue < 0) {
            errorDiv.textContent = 'Payment amount cannot be negative';
            errorDiv.style.display = 'block';
            return false;
        }
        
        // Check if it has more than 2 decimal places
        const decimalPlaces = (value.split('.')[1] || '').length;
        if (decimalPlaces > 2) {
            errorDiv.textContent = 'Payment amount can have maximum 2 decimal places';
            errorDiv.style.display = 'block';
            return false;
        }
        
        // Check if it's too large (prevent overflow)
        if (numValue > 999999999.99) {
            errorDiv.textContent = 'Payment amount is too large';
            errorDiv.style.display = 'block';
            return false;
        }
        
        return true;
    }
    
    // Participant count validation function
    function validateParticipantCount(input) {
        const value = input.value;
        const errorDiv = document.getElementById('participantCountError');
        
        // Clear previous error
        errorDiv.style.display = 'none';
        
        // Check if empty
        if (!value) {
            return true; // Let HTML5 validation handle required field
        }
        
        // Check if it's a valid integer
        const intValue = parseInt(value);
        if (isNaN(intValue)) {
            errorDiv.textContent = 'Please enter a valid number';
            errorDiv.style.display = 'block';
            return false;
        }
        
        // Check if it's less than 1
        if (intValue < 1) {
            errorDiv.textContent = 'Participant count must be at least 1';
            errorDiv.style.display = 'block';
            return false;
        }
        
        // Check if it's too large (prevent overflow)
        if (intValue > 999999) {
            errorDiv.textContent = 'Participant count is too large';
            errorDiv.style.display = 'block';
            return false;
        }
        
        return true;
    }
    
    // Initialize page data when DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
        console.log('üöÄ Page loaded, initializing data...');
        
        // Check if user is logged in and not logging out before loading data
        const currentUser = userSession.currentUser || {};
        if (!currentUser.username || window.isLoggingOut) {
            console.log('‚ö†Ô∏è User not logged in or logging out, skipping data loading');
            return;
        }
        
        // Handle hash navigation for direct links
        const hash = window.location.hash.substring(1); // Remove the # symbol
        
        // Only load default data if no specific section is requested
        if (!hash) {
            // Load 1099 data automatically for dashboard overview
            load1099Data();
            
            // Load insurance data automatically
            loadInsuranceData();
        }
        if (hash) {
            // Check if user is logged in and not logging out before loading data
            const currentUser = userSession.currentUser || {};
            if (!currentUser.username || window.isLoggingOut) {
                console.log('‚ö†Ô∏è User not logged in or logging out, skipping initial hash navigation data loading');
                return;
            }
            const targetLink = document.querySelector(`a[data-section="${hash}"]`);
            if (targetLink) {
                // Remove active class from all links and sections
                document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
                
                // Add active class to target link
                targetLink.classList.add('active');
                
                // Show target section
                const targetSection = document.getElementById(hash);
                if (targetSection) {
                    targetSection.classList.add('active');
                }
                
                // Load section-specific data if needed
                switch(hash) {
                    case 'officers':
                        loadOfficersData();
                        break;
                    case 'club-websites':
                        loadWebsiteLinks();
                        break;
                    case 'volunteers':
                        loadVolunteerData();
                        break;
                    case 'news':
                        loadNewsData();
                        break;
                    case 'links':
                        loadLinksData();
                        break;
                    case 'insurance':
                        loadInsuranceData();
                        break;
                    case '1099':
                        load1099Data();
                        break;
                    case 'content':
                        loadContentData();
                        break;
                    case 'users':
                        loadUsersData();
                        break;
                    case 'profile':
                        checkFirstLogin();
                        break;

                }
            }
        }
        
        console.log('‚úÖ Page initialization complete');
        

        
        // Listen for hash changes (browser back/forward buttons, programmatic changes)
        window.addEventListener('hashchange', function() {
            // Check if user is still logged in and not logging out before loading data
            const currentUser = userSession.currentUser || {};
            if (!currentUser.username || window.isLoggingOut) {
                console.log('‚ö†Ô∏è User not logged in or logging out, skipping hash navigation data loading');
                return;
            }
            
            const hash = window.location.hash.substring(1);
            if (hash) {
                const targetLink = document.querySelector(`a[data-section="${hash}"]`);
                if (targetLink) {
                    // Remove active class from all links and sections
                    document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                    document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
                    
                    // Add active class to target link
                    targetLink.classList.add('active');
                    
                    // Show target section
                    const targetSection = document.getElementById(hash);
                    if (targetSection) {
                        targetSection.classList.add('active');
                    }
                    
                    // Load section-specific data if needed
                    switch(hash) {
                        case 'officers':
                            loadOfficersData();
                            break;
                        case 'club-websites':
                            loadWebsiteLinks();
                            break;
                        case 'volunteers':
                            loadVolunteerData();
                            break;
                        case 'news':
                            loadNewsData();
                            break;
                        case 'links':
                            loadLinksData();
                            break;
                        case 'insurance':
                            loadInsuranceData();
                            break;
                        case '1099':
                            load1099Data();
                            break;
                        case 'content':
                            loadContentData();
                            break;
                        case 'users':
                            loadUsersData();
                            break;
                        case 'profile':
                            checkFirstLogin();
                            break;

                    }
                }
            }
        });
    });

    // Helper function to get booster club display name
    function getBoosterClubDisplayName(boosterClub) {
        const clubNames = {
            'band': 'Eastlake Band Boosters',
            'baseball': 'Eastlake Baseball Club',
            'boys-basketball': 'Eastlake Boys Basketball Booster Club',
            'girls-basketball': 'Eastlake Girls Basketball Booster Club',
            'cheer': 'Eastlake Cheer Booster Club',
            'choir': 'Eastlake Choir',
            'cross-country': 'Eastlake Cross-Country Boosters',
            'dance': 'Eastlake Dance Team Boosters',
            'deca': 'Eastlake DECA Booster Club',
            'drama': 'Eastlake Drama Boosters',
            'fastpitch': 'Eastlake Fastpitch (Girls)',
            'boys-golf': 'Eastlake Boys Golf Booster Club',
            'girls-golf': 'Eastlake Girls Golf Booster Club',
            'orchestra': 'Eastlake Orchestra Boosters Club',
            'robotics': 'Eastlake Robotics Club',
            'boys-soccer': 'Eastlake Boys Soccer',
            'girls-soccer': 'Eastlake Girls Soccer',
            'boys-swim': 'Eastlake Boys Swim & Dive Booster Club',
            'girls-swim': 'Eastlake Girls Swim & Dive Booster Club',
            'track': 'Eastlake Track and Field Booster Club',
            'volleyball': 'Eastlake Volleyball Booster Club',
            'wrestling': 'Eastlake Wrestling Booster Club'
        };
        return clubNames[boosterClub] || boosterClub || 'N/A';
    }

    // Toggle select all checkboxes
    function toggleSelectAll1099() {
        console.log('üîÑ Toggle select all called');
        const selectAllCheckbox = document.getElementById('selectAll1099');
        const checkboxes = document.querySelectorAll('.checkbox-1099');
        
        console.log('üìã Found checkboxes:', checkboxes.length);
        console.log('‚úÖ Select all checkbox checked:', selectAllCheckbox.checked);
        
        checkboxes.forEach((checkbox, index) => {
            checkbox.checked = selectAllCheckbox.checked;
            console.log(`üìù Checkbox ${index + 1} set to:`, checkbox.checked);
        });
        
        updateExportButtons();
        updateSelectAllCheckbox();
    }

    // Update export buttons visibility
    function updateExportButtons() {
        console.log('üîß Update export buttons called');
        
        // Use a safer approach to find checked checkboxes
        const allCheckboxes = document.querySelectorAll('.checkbox-1099');
        const checkedCheckboxes = Array.from(allCheckboxes).filter(cb => cb.checked);
        
        const exportBtn = document.getElementById('export1099Btn');
        const downloadW9Btn = document.getElementById('downloadW9Btn');
        
        console.log('üìã Checked checkboxes:', checkedCheckboxes.length);
        console.log('üìä Export button found:', !!exportBtn);
        console.log('üìÅ Download W9 button found:', !!downloadW9Btn);
        
        if (checkedCheckboxes.length > 0) {
            console.log('‚úÖ Showing buttons');
            exportBtn.style.display = 'inline-block';
            downloadW9Btn.style.display = 'inline-block';
        } else {
            console.log('‚ùå Hiding buttons');
            exportBtn.style.display = 'none';
            downloadW9Btn.style.display = 'none';
        }
        
        updateSelectAllCheckbox();
    }

    // Update select all checkbox state
    function updateSelectAllCheckbox() {
        const selectAllCheckbox = document.getElementById('selectAll1099');
        const checkboxes = document.querySelectorAll('.checkbox-1099');
        const checkedCheckboxes = Array.from(checkboxes).filter(cb => cb.checked);
        
        if (checkboxes.length === 0) {
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = false;
        } else if (checkedCheckboxes.length === 0) {
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = false;
        } else if (checkedCheckboxes.length === checkboxes.length) {
            selectAllCheckbox.checked = true;
            selectAllCheckbox.indeterminate = false;
        } else {
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = true;
        }
    }

    // Filter 1099 data by year
    function filter1099ByYear() {
        const yearFilter = document.getElementById('yearFilter').value;
        const currentSubmissions = window.current1099Submissions || [];
        
        if (!yearFilter) {
            display1099Data(currentSubmissions);
        } else {
            const filteredSubmissions = currentSubmissions.filter(sub => 
                sub.tax_year.toString() === yearFilter
            );
            display1099Data(filteredSubmissions);
        }
    }

    // Update 1099 status
    async function update1099Status(formId, status) {
        try {
            const response = await fetch(`/api/1099/${formId}/status`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ status })
            });
            
            const data = await response.json();
            
            if (data.success) {
                console.log('‚úÖ Status updated successfully');
                // Optionally refresh the data
                load1099Data();
            } else {
                alert('Error updating status: ' + data.message);
            }
        } catch (error) {
            console.error('Error updating status:', error);
            alert('Error updating status. Please try again.');
        }
    }

    // Export selected 1099 data
    async function exportSelected1099() {
        const allCheckboxes = document.querySelectorAll('.checkbox-1099');
        const checkedCheckboxes = Array.from(allCheckboxes).filter(cb => cb.checked);
        const submissionIds = checkedCheckboxes.map(cb => cb.value);
        
        if (submissionIds.length === 0) {
            alert('Please select at least one submission to export');
            return;
        }
        
        try {
            const response = await fetch('/api/1099/export', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ submissionIds, format: 'csv' })
            });
            
            if (response.ok) {
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `1099-submissions-${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            } else {
                const data = await response.json();
                alert('Error exporting data: ' + data.message);
            }
        } catch (error) {
            console.error('Error exporting data:', error);
            alert('Error exporting data. Please try again.');
        }
    }

    // Download selected W9 files
    async function downloadSelectedW9() {
        const allCheckboxes = document.querySelectorAll('.checkbox-1099');
        const checkedCheckboxes = Array.from(allCheckboxes).filter(cb => cb.checked);
        const submissionIds = checkedCheckboxes.map(cb => cb.value);
        
        if (submissionIds.length === 0) {
            alert('Please select at least one submission to download W9 files');
            return;
        }
        
        try {
            const response = await fetch('/api/1099/download-w9', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ submissionIds })
            });
            
            const data = await response.json();
            
            if (data.success) {
                // For now, we'll download files individually
                // In a full implementation, this would create a zip file
                data.files.forEach(file => {
                    const a = document.createElement('a');
                    a.href = file.w9BlobUrl;
                    a.download = file.w9Filename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                });
                
                alert(`Downloaded ${data.files.length} W9 file(s)`);
            } else {
                alert('Error downloading W9 files: ' + data.message);
            }
        } catch (error) {
            console.error('Error downloading W9 files:', error);
            alert('Error downloading W9 files. Please try again.');
        }
    }

    // Delete 1099 submission
    async function delete1099Submission(formId, recipientName) {
        if (!confirm(`Are you sure you want to delete the 1099 submission for ${recipientName}?`)) {
            return;
        }
        
        try {
            const response = await fetch(`/api/1099/${formId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            
            const data = await response.json();
            
            if (data.success) {
                alert('1099 submission deleted successfully');
                load1099Data();
            } else {
                alert('Error deleting submission: ' + data.message);
            }
        } catch (error) {
            console.error('Error deleting submission:', error);
            alert('Error deleting submission. Please try again.');
        }
    }

    // Edit 1099 submission
    async function edit1099Submission(formId) {
        try {
            // Find the submission in the current data
            const submission = window.current1099Submissions.find(sub => sub.id === formId);
            if (!submission) {
                alert('Submission not found');
                return;
            }

            // Create a modal for editing
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
            `;

            modal.innerHTML = `
                <div style="background: white; padding: 20px; border-radius: 8px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;">
                    <h3>Edit 1099 Submission</h3>
                    <form id="edit1099Form">
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Recipient Name *</label>
                            <input type="text" id="editRecipientName" value="${submission.recipient_name || ''}" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Tax ID *</label>
                            <input type="text" id="editRecipientTin" value="${submission.recipient_tin || ''}" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Amount *</label>
                            <input type="number" id="editAmount" value="${submission.amount || ''}" step="0.01" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Description</label>
                            <textarea id="editDescription" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; height: 60px;">${submission.description || ''}</textarea>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Calendar Year *</label>
                            <select id="editTaxYear" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                <option value="2024" ${submission.tax_year === 2024 ? 'selected' : ''}>2024</option>
                                <option value="2025" ${submission.tax_year === 2025 ? 'selected' : ''}>2025</option>
                                <option value="2026" ${submission.tax_year === 2026 ? 'selected' : ''}>2026</option>
                            </select>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Booster Club *</label>
                            <select id="editBoosterClub" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                <option value="">Select Booster Club</option>
                                <!-- Clubs will be loaded dynamically from database -->
                            </select>
                        </div>
                        <div style="display: flex; gap: 10px; justify-content: flex-end;">
                            <button type="button" onclick="closeEditModal()" style="padding: 8px 16px; border: 1px solid #ddd; background: #f8f9fa; border-radius: 4px; cursor: pointer;">Cancel</button>
                            <button type="submit" style="padding: 8px 16px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">Save Changes</button>
                        </div>
                    </form>
                </div>
            `;

            document.body.appendChild(modal);

            // Populate the dropdown with clubs from database
            const clubSelect = document.getElementById('editBoosterClub');
            if (clubSelect && allBoosterClubs.length > 0) {
                // Keep the first "Select" option
                const firstOption = clubSelect.querySelector('option');
                clubSelect.innerHTML = '';
                if (firstOption) {
                    clubSelect.appendChild(firstOption);
                }
                
                // Add clubs from database
                allBoosterClubs.forEach(club => {
                    const option = document.createElement('option');
                    option.value = club.name;
                    option.textContent = club.name;
                    if (submission.booster_club === club.name) {
                        option.selected = true;
                    }
                    clubSelect.appendChild(option);
                });
            }

            // Handle form submission
            document.getElementById('edit1099Form').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const formData = {
                    recipientName: document.getElementById('editRecipientName').value,
                    recipientTin: document.getElementById('editRecipientTin').value,
                    amount: document.getElementById('editAmount').value,
                    description: document.getElementById('editDescription').value,
                    taxYear: document.getElementById('editTaxYear').value,
                    boosterClub: document.getElementById('editBoosterClub').value
                };

                try {
                    const response = await fetch(`/api/1099/${formId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(formData)
                    });

                    const data = await response.json();
                    
                    if (data.success) {
                        alert('1099 submission updated successfully!');
                        closeEditModal();
                        load1099Data(); // Refresh the data
                    } else {
                        alert('Error updating submission: ' + data.message);
                    }
                } catch (error) {
                    console.error('Error updating submission:', error);
                    alert('Error updating submission. Please try again.');
                }
            });

        } catch (error) {
            console.error('Error opening edit modal:', error);
            alert('Error opening edit form. Please try again.');
        }
    }

    // Close edit modal
    function closeEditModal() {
        const modal = document.querySelector('div[style*="position: fixed"]');
        if (modal) {
            modal.remove();
        }
    }

    // Delete 1099 submission
    async function delete1099Submission(formId, recipientName) {
        if (!confirm(`Are you sure you want to delete the 1099 submission for "${recipientName}"? This action cannot be undone.`)) {
            return;
        }

        try {
            const response = await fetch(`/api/1099/${formId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                }
            });

            const data = await response.json();
            
            if (data.success) {
                alert('1099 submission deleted successfully!');
                load1099Data(); // Refresh the data
            } else {
                alert('Error deleting submission: ' + data.message);
            }
        } catch (error) {
            console.error('Error deleting submission:', error);
            alert('Error deleting submission. Please try again.');
        }
    }

    // ===== SECURITY DASHBOARD FUNCTIONS =====
    
    // Load dashboard data
    async function loadSecurityDashboard() {
        try {
            const response = await fetch('/api/security/dashboard');
            const data = await response.json();
            
            if (data.success) {
                updateSecurityScore(data.data.securityScore);
                updateVulnerabilities(data.data.vulnerabilities);
                updateRecommendations(data.data.recommendations);
                updateLastScan(data.data.lastScan);
            }
        } catch (error) {
            console.error('Error loading security dashboard:', error);
        }
    }

    // Update security score
    function updateSecurityScore(score) {
        const scoreElement = document.getElementById('securityScore');
        if (scoreElement) {
            scoreElement.textContent = score;
        }
    }

    // Update vulnerabilities
    function updateVulnerabilities(vulns) {
        const countElement = document.getElementById('vulnerabilityCount');
        const criticalElement = document.getElementById('criticalCount');
        const highElement = document.getElementById('highCount');
        const moderateElement = document.getElementById('moderateCount');
        const lowElement = document.getElementById('lowCount');
        
        if (vulns) {
            const total = (vulns.critical || 0) + (vulns.high || 0) + (vulns.moderate || 0) + (vulns.low || 0);
            
            if (countElement) countElement.textContent = total;
            if (criticalElement) criticalElement.textContent = vulns.critical || 0;
            if (highElement) highElement.textContent = vulns.high || 0;
            if (moderateElement) moderateElement.textContent = vulns.moderate || 0;
            if (lowElement) lowElement.textContent = vulns.low || 0;
        }
    }

    // Update recommendations
    function updateRecommendations(recommendations) {
        const container = document.getElementById('securityRecommendations');
        
        if (!recommendations || recommendations.length === 0) {
            container.innerHTML = '<p>No recommendations available.</p>';
            return;
        }

        let html = '<ul>';
        recommendations.forEach(rec => {
            html += `
                <li>
                    <strong>${rec.priority.toUpperCase()}: ${rec.category}</strong><br>
                    ${rec.message}<br>
                    <em>Action: ${rec.action}</em>
                </li>
            `;
        });
        html += '</ul>';
        
        container.innerHTML = html;
    }

    // Update last scan time
    function updateLastScan(timestamp) {
        if (timestamp) {
            const date = new Date(timestamp);
            console.log('Last security scan:', date.toLocaleString());
        }
    }

    // Run security scan
    async function runSecurityScan() {
        const button = event.target;
        const originalText = button.textContent;
        button.textContent = 'üîç Scanning...';
        button.disabled = true;

        try {
            const response = await fetch('/api/security/scan', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
            
            const data = await response.json();
            
            if (data.success) {
                alert('Security scan completed successfully!');
                loadSecurityDashboard(); // Refresh dashboard
            } else {
                alert('Security scan failed: ' + data.message);
            }
        } catch (error) {
            console.error('Error running security scan:', error);
            alert('Error running security scan');
        } finally {
            button.textContent = originalText;
            button.disabled = false;
        }
    }

    // Run test coverage
    async function runTestCoverage() {
        const button = event.target;
        const originalText = button.textContent;
        button.textContent = 'üß™ Running Tests...';
        button.disabled = true;

        try {
            const response = await fetch('/api/security/test-coverage', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
            
            const data = await response.json();
            
            if (data.success) {
                alert(`Test coverage completed!\nPassed: ${data.data.passedTests}\nFailed: ${data.data.failedTests}\nCoverage: ${data.data.coverage}%`);
                loadCoverageData();
            } else {
                alert('Test coverage failed: ' + data.message);
            }
        } catch (error) {
            console.error('Error running test coverage:', error);
            alert('Error running test coverage');
        } finally {
            button.textContent = originalText;
            button.disabled = false;
        }
    }

    // Load coverage data
    async function loadCoverageData() {
        try {
            const response = await fetch('/api/security/coverage');
            const data = await response.json();
            
            if (data.success) {
                updateCoverage(data.data.overallCoverage);
            } else {
                console.log('No coverage data available:', data.message);
                updateCoverage(null);
            }
        } catch (error) {
            console.error('Error loading coverage:', error);
        }
    }

    // Update coverage display
    function updateCoverage(coverage) {
        const container = document.getElementById('codeCoverage');
        if (container) {
            if (coverage === null || coverage === undefined) {
                container.textContent = 'N/A';
                container.title = 'No coverage data available. Run tests with coverage to generate data.';
                container.style.color = '#6c757d';
            } else {
                container.textContent = coverage + '%';
                container.title = 'Test coverage percentage';
                container.style.color = '#28a745';
            }
        }
    }

    // View security report
    async function viewSecurityReport() {
        try {
            const response = await fetch('/api/security/report');
            const data = await response.json();
            
            if (data.success) {
                displayBeautifulSecurityReport(data.data);
                document.getElementById('securityReportModal').style.display = 'block';
            } else {
                showAlert('Failed to load security report: ' + data.message, 'danger');
            }
        } catch (error) {
            console.error('Error loading security report:', error);
            showAlert('Error loading security report', 'danger');
        }
    }

    // Display beautiful formatted security report
    function displayBeautifulSecurityReport(reportData) {
        const container = document.getElementById('securityReportContent');
        
        const html = `
            <div class="report-section">
                <h3>üìä Security Summary</h3>
                <div class="metric-grid">
                    <div class="metric-card">
                        <div class="metric-value" style="color: #28a745;">${reportData.summary.totalVulnerabilities}</div>
                        <div class="metric-label">Total Vulnerabilities</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" style="color: #667eea;">${reportData.summary.totalIssues}</div>
                        <div class="metric-label">Code Issues</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" style="color: #ffc107;">${reportData.summary.recommendations}</div>
                        <div class="metric-label">Recommendations</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" style="color: #17a2b8;">${new Date(reportData.summary.timestamp).toLocaleDateString()}</div>
                        <div class="metric-label">Scan Date</div>
                    </div>
                </div>
            </div>

            <div class="report-section">
                <h3>üì¶ Dependency Analysis</h3>
                <div class="dependency-stats">
                    <div class="dependency-stat">
                        <div class="dependency-number">${reportData.details.dependencies.metadata.dependencies.prod}</div>
                        <div class="dependency-label">Production</div>
                    </div>
                    <div class="dependency-stat">
                        <div class="dependency-number">${reportData.details.dependencies.metadata.dependencies.dev}</div>
                        <div class="dependency-label">Development</div>
                    </div>
                    <div class="dependency-stat">
                        <div class="dependency-number">${reportData.details.dependencies.metadata.dependencies.optional}</div>
                        <div class="dependency-label">Optional</div>
                    </div>
                    <div class="dependency-stat">
                        <div class="dependency-number">${reportData.details.dependencies.metadata.dependencies.total}</div>
                        <div class="dependency-label">Total</div>
                    </div>
                </div>
                
                <h4>Vulnerability Breakdown</h4>
                <div class="dependency-stats">
                    <div class="dependency-stat">
                        <div class="dependency-number" style="color: #dc3545;">${reportData.details.dependencies.severityCounts.critical}</div>
                        <div class="dependency-label">Critical</div>
                    </div>
                    <div class="dependency-stat">
                        <div class="dependency-number" style="color: #fd7e14;">${reportData.details.dependencies.severityCounts.high}</div>
                        <div class="dependency-label">High</div>
                    </div>
                    <div class="dependency-stat">
                        <div class="dependency-number" style="color: #ffc107;">${reportData.details.dependencies.severityCounts.moderate}</div>
                        <div class="dependency-label">Moderate</div>
                    </div>
                    <div class="dependency-stat">
                        <div class="dependency-number" style="color: #28a745;">${reportData.details.dependencies.severityCounts.low}</div>
                        <div class="dependency-label">Low</div>
                    </div>
                </div>
            </div>

            <div class="report-section">
                <h3>üîç Code Quality Analysis</h3>
                <div class="metric-grid">
                    <div class="metric-card">
                        <div class="metric-value" style="color: #667eea;">${reportData.details.codeIssues.totalIssues}</div>
                        <div class="metric-label">Total Issues</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" style="color: #dc3545;">${reportData.details.codeIssues.securityIssues.length}</div>
                        <div class="metric-label">Security Issues</div>
                    </div>
                </div>
                ${reportData.details.codeIssues.error ? 
                    `<p style="color: #fd7e14; background: #fff3cd; padding: 10px; border-radius: 5px; border-left: 4px solid #ffc107;">
                        <strong>Note:</strong> ${reportData.details.codeIssues.error}
                    </p>` : ''
                }
            </div>

            <div class="report-section">
                <h3>üí° Security Recommendations</h3>
                <ul class="recommendation-list">
                    ${reportData.details.recommendations.map(rec => `
                        <li>
                            <div class="recommendation-priority priority-${rec.priority}">
                                ${rec.priority.toUpperCase()}: ${rec.category}
                            </div>
                            <div style="margin: 5px 0;">${rec.message}</div>
                            <div style="font-size: 0.9rem; color: #666; font-style: italic;">
                                Action: ${rec.action}
                            </div>
                        </li>
                    `).join('')}
                </ul>
            </div>

            <div class="report-section">
                <h3>üìÖ Scan Information</h3>
                <p><strong>Scan Timestamp:</strong> ${new Date(reportData.details.timestamp).toLocaleString()}</p>
                <p><strong>Report Generated:</strong> ${new Date().toLocaleString()}</p>
            </div>
        `;
        
        container.innerHTML = html;
    }

    // Close security report modal
    function closeSecurityReportModal() {
        document.getElementById('securityReportModal').style.display = 'none';
    }

    // Load security dashboard data when section is shown
    function loadSecurityDashboardData() {
        loadSecurityDashboard();
        loadCoverageData();
    }



    // Content Management Functions
    let currentClubData = null;

    // Load content management data
    async function loadContentManagementData() {
        try {
            const response = await fetch('/api/booster-clubs');
            const result = await response.json();

            if (result.success) {
                // Populate the club select dropdown
                const clubSelect = document.getElementById('clubSelect');
                if (clubSelect) {
                    // Clear existing options except the first one
                    clubSelect.innerHTML = '<option value="">Select Booster Club</option>';
                    
                    result.data.forEach(club => {
                        const option = document.createElement('option');
                        option.value = club.name;
                        option.textContent = club.name;
                        clubSelect.appendChild(option);
                    });
                }
            } else {
                showAlert('Failed to load booster clubs', 'danger');
            }
        } catch (error) {
            console.error('Error loading content management data:', error);
            showAlert('Error loading content management data', 'danger');
        }
    }

    // Load club description when club is selected
    async function loadClubDescription() {
        const clubSelect = document.getElementById('clubSelect');
        const descriptionTextarea = document.getElementById('clubDescription');
        
        if (!clubSelect || !descriptionTextarea) return;
        
        const selectedClub = clubSelect.value;
        if (!selectedClub) {
            descriptionTextarea.value = '';
            return;
        }
        
        try {
            const response = await fetch(`/api/booster-clubs/${encodeURIComponent(selectedClub)}`);
            const result = await response.json();
            
            if (result.success) {
                currentClubData = result.data;
                descriptionTextarea.value = result.data.description || '';
            } else {
                showAlert('Failed to load club description', 'danger');
                descriptionTextarea.value = '';
            }
        } catch (error) {
            console.error('Error loading club description:', error);
            showAlert('Error loading club description', 'danger');
            descriptionTextarea.value = '';
        }
    }

    // Update club description
    async function updateClubDescription() {
        const clubSelect = document.getElementById('clubSelect');
        const descriptionTextarea = document.getElementById('clubDescription');
        
        if (!clubSelect || !descriptionTextarea) return;
        
        const selectedClub = clubSelect.value;
        const description = descriptionTextarea.value.trim();
        
        if (!selectedClub) {
            showAlert('Please select a booster club', 'warning');
            return;
        }
        
        if (!description) {
            showAlert('Please enter a description', 'warning');
            return;
        }
        
        try {
            const response = await fetch(`/api/booster-clubs/${encodeURIComponent(selectedClub)}/description`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ description })
            });
            
            const result = await response.json();
            
            if (result.success) {
                showAlert('Club description updated successfully!', 'success');
                currentClubData = result.data;
            } else {
                showAlert('Failed to update club description: ' + result.message, 'danger');
            }
        } catch (error) {
            console.error('Error updating club description:', error);
            showAlert('Error updating club description', 'danger');
        }
    }

    // Add event listener for security dashboard section
    document.addEventListener('DOMContentLoaded', () => {
        // Load booster clubs from database (single source of truth)
        loadBoosterClubs();
        
        // Check if we're on the security dashboard section
        const securitySection = document.getElementById('security-dashboard');
        if (securitySection && securitySection.style.display !== 'none') {
            loadSecurityDashboardData();
        }
        

    });

    // ===== PAYMENT MANAGEMENT FUNCTIONALITY =====
    
    // Global variables for payment management
    let currentPaymentData = null;
    let allPaymentData = [];

    // Load payment management data when section is shown
    function loadPaymentManagementData() {
        loadPaymentStatusOverview();
        loadPaymentLinksTable();
        populatePaymentClubDropdowns();
    }

    // Load payment status overview
    async function loadPaymentStatusOverview() {
        try {
            const response = await fetch('/api/admin/payment-status');
            const data = await response.json();
            
            if (data.success) {
                document.getElementById('clubsWithZelle').textContent = data.stats.clubsWithZelle || 0;
                document.getElementById('clubsWithStripe').textContent = data.stats.clubsWithStripe || 0;
                document.getElementById('paymentEnabled').textContent = data.stats.paymentEnabled || 0;
                document.getElementById('totalClubs').textContent = data.stats.totalClubs || 0;
            } else {
                console.error('Error loading payment status:', data.message);
            }
        } catch (error) {
            console.error('Error loading payment status:', error);
        }
    }

    // Load payment links for selected Zelle club
    async function loadZelleLink(clubId) {
        try {
            const response = await fetch(`/api/admin/payment-settings/club/${clubId}`);
            const data = await response.json();
            
            if (data.success) {
                document.getElementById('zelleUrl').value = data.data.zelle_url || '';
                document.getElementById('zelleEnabled').checked = data.data.is_payment_enabled || false;
            } else {
                showAlert('Failed to load Zelle settings: ' + data.message, 'danger');
            }
        } catch (error) {
            console.error('Error loading Zelle settings:', error);
            showAlert('Error loading Zelle settings', 'danger');
        }
    }

    // Load payment links for selected Stripe club
    async function loadStripeLinks(clubId) {
        try {
            const response = await fetch(`/api/admin/payment-settings/club/${clubId}`);
            const data = await response.json();
            
            if (data.success) {
                            // Simple string handling - no JSON parsing needed
            const stripeUrl = data.data.stripe_url || '';
                
                document.getElementById('stripeUrl').value = stripeUrl;
                document.getElementById('stripeEnabled').checked = data.data.is_payment_enabled || false;
            } else {
                showAlert('Failed to load Stripe settings: ' + data.message, 'danger');
            }
        } catch (error) {
            console.error('Error loading Stripe settings:', error);
            showAlert('Error loading Stripe settings', 'danger');
        }
    }

    // Update Zelle link
    async function updateZelleLink() {
        const clubId = document.getElementById('zelleClubSelect').value;
        const zelleUrl = document.getElementById('zelleUrl').value.trim();
        const zelleEnabled = document.getElementById('zelleEnabled').checked;

        if (!clubId) {
            showAlert('Please select a club first', 'warning');
            return;
        }

        try {
            // First, get current data to preserve existing Stripe settings
            const currentResponse = await fetch(`/api/admin/payment-settings/club/${clubId}`);
            const currentData = await currentResponse.json();
            
            if (!currentData.success) {
                showAlert('Failed to load current settings: ' + currentData.message, 'danger');
                return;
            }
            
            // Prepare update data - preserve existing Stripe settings
            const updateData = {
                zelle_url: zelleUrl,
                is_payment_enabled: zelleEnabled
            };
            
            // Preserve existing Stripe URL if it exists
            if (currentData.data.stripe_url) {
                updateData.stripe_url = currentData.data.stripe_url;
            }
            
            const response = await fetch(`/api/admin/payment-settings/club/${clubId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(updateData)
            });
            
            const data = await response.json();
            
            if (data.success) {
                showAlert('Zelle link updated successfully!', 'success');
                loadPaymentLinksTable(); // Refresh the table
            } else {
                showAlert('Failed to update Zelle link: ' + data.message, 'danger');
            }
        } catch (error) {
            console.error('Error updating Zelle link:', error);
            showAlert('Error updating Zelle link', 'danger');
        }
    }

    // Update Stripe links
    async function updateStripeLinks() {
        const clubId = document.getElementById('stripeClubSelect').value;
        const stripeUrl = document.getElementById('stripeUrl').value.trim();
        const stripeEnabled = document.getElementById('stripeEnabled').checked;

        if (!clubId) {
            showAlert('Please select a club first', 'warning');
            return;
        }

        try {
            // First, get current data to preserve existing Zelle settings
            const currentResponse = await fetch(`/api/admin/payment-settings/club/${clubId}`);
            const currentData = await currentResponse.json();
            
            if (!currentData.success) {
                showAlert('Failed to load current settings: ' + currentData.message, 'danger');
                return;
            }
            
            // Prepare update data - preserve existing Zelle settings
            const updateData = {
                stripe_url: stripeUrl,
                is_payment_enabled: stripeEnabled
            };
            
            // Preserve existing Zelle URL if it exists
            if (currentData.data.zelle_url) {
                updateData.zelle_url = currentData.data.zelle_url;
            }
            
            const response = await fetch(`/api/admin/payment-settings/club/${clubId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(updateData)
            });
            
            const data = await response.json();
            
            if (data.success) {
                showAlert('Stripe link updated successfully!', 'success');
                loadPaymentLinksTable(); // Refresh the table
            } else {
                showAlert('Failed to update Stripe link: ' + data.message, 'danger');
            }
        } catch (error) {
            console.error('Error updating Stripe link:', error);
            showAlert('Error updating Stripe links', 'danger');
        }
    }

    // Load payment links table
    async function loadPaymentLinksTable() {
        try {
            const response = await fetch('/api/admin/payment-settings');
            const data = await response.json();
            
            if (data.success) {
                displayPaymentLinksTable(data.data);
            } else {
                console.error('Error loading payment links:', data.message);
            }
        } catch (error) {
            console.error('Error loading payment links:', error);
        }
    }

    // Display payment links in table
    function displayPaymentLinksTable(clubs) {
        const tbody = document.getElementById('paymentLinksTableBody');
        if (!tbody) return;

        tbody.innerHTML = '';

        clubs.forEach(club => {
            const row = document.createElement('tr');
            
            const zelleUrl = club.zelle_url || 'Not configured';
            
            // Simple string handling - no JSON parsing needed
            const stripeUrl = club.stripe_url || 'Not configured';
            
            const status = club.is_payment_enabled ? 
                '<span class="status-approved">Enabled</span>' : 
                '<span class="status-pending">Disabled</span>';

            row.innerHTML = `
                <td>${club.name}</td>
                <td>${zelleUrl}</td>
                <td>${stripeUrl}</td>
                <td>${status}</td>
                <td>
                    <button class="btn btn-sm btn-primary" onclick="editPaymentLinks('${club.id}')">Edit</button>
                </td>
            `;
            
            tbody.appendChild(row);
        });
    }

    // Populate payment club dropdowns
    async function populatePaymentClubDropdowns() {
        try {
            const response = await fetch('/api/admin/payment-settings');
            const data = await response.json();
            
            if (data.success) {
                const clubs = data.data;
                
                // Populate Zelle dropdown
                const zelleSelect = document.getElementById('zelleClubSelect');
                if (zelleSelect) {
                    zelleSelect.innerHTML = '<option value="">Select Booster Club</option>';
                    clubs.forEach(club => {
                        const option = document.createElement('option');
                        option.value = club.id;
                        option.textContent = club.name;
                        zelleSelect.appendChild(option);
                    });
                }
                
                // Populate Stripe dropdown
                const stripeSelect = document.getElementById('stripeClubSelect');
                if (stripeSelect) {
                    stripeSelect.innerHTML = '<option value="">Select Booster Club</option>';
                    clubs.forEach(club => {
                        const option = document.createElement('option');
                        option.value = club.id;
                        option.textContent = club.name;
                        stripeSelect.appendChild(option);
                    });
                }
                
                // Store clubs data for edit function
                window.paymentClubsData = clubs;
            }
        } catch (error) {
            console.error('Error populating payment club dropdowns:', error);
        }
    }

    // Edit payment links for a specific club
    function editPaymentLinks(clubId) {
        const club = window.paymentClubsData?.find(c => c.id === clubId);
        if (!club) {
            console.error('Club not found:', clubId);
            return;
        }

        // Set the club in both dropdowns
        document.getElementById('zelleClubSelect').value = clubId;
        document.getElementById('stripeClubSelect').value = clubId;
        
        // Load the data
        loadZelleLink(clubId);
        loadStripeLinks(clubId);
        
        // Scroll to the forms
        document.getElementById('payment-management').scrollIntoView({ behavior: 'smooth' });
        
        // Show a brief message to indicate the club was selected
        showAlert(`Editing payment settings for ${club.name}`, 'info');
    }

                // Export payment data
            async function exportPaymentData() {
                try {
                    const response = await fetch('/api/admin/payment-settings');
                    const data = await response.json();
                    
                    if (data.success) {
                        const csvContent = convertToCSV(data.data);
                        downloadCSV(csvContent, 'payment-data.csv');
                        showAlert('Payment data exported successfully!', 'success');
                    } else {
                        showAlert('Failed to export payment data: ' + data.message, 'danger');
                    }
                } catch (error) {
                    console.error('Error exporting payment data:', error);
                    showAlert('Error exporting payment data', 'danger');
                }
            }



            // Convert data to CSV
            function convertToCSV(data) {
                const headers = ['Club Name', 'Zelle URL', 'Stripe Payment Link', 'Payment Enabled'];
                const rows = data.map(club => {
                    // Simple string handling - no JSON parsing needed
                    const stripeUrl = club.stripe_url || '';
                    
                    return [
                        club.name,
                        club.zelle_url || '',
                        stripeUrl,
                        club.is_payment_enabled ? 'Yes' : 'No'
                    ];
                });
                
                return [headers, ...rows].map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
            }

            // Download CSV file
            function downloadCSV(content, filename) {
                const blob = new Blob([content], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            }

            // Event listeners for payment management
            document.addEventListener('DOMContentLoaded', () => {
                // Zelle club selection change
                const zelleClubSelect = document.getElementById('zelleClubSelect');
                if (zelleClubSelect) {
                    zelleClubSelect.addEventListener('change', function() {
                        const clubId = this.value;
                        if (clubId) {
                            loadZelleLink(clubId);
                        } else {
                            document.getElementById('zelleUrl').value = '';
                            document.getElementById('zelleEnabled').checked = false;
                        }
                    });
                }

                // Stripe club selection change
                const stripeClubSelect = document.getElementById('stripeClubSelect');
                if (stripeClubSelect) {
                    stripeClubSelect.addEventListener('change', function() {
                        const clubId = this.value;
                        if (clubId) {
                            loadStripeLinks(clubId);
                        } else {
                            document.getElementById('stripeUrl').value = '';
                            document.getElementById('stripeEnabled').checked = false;
                        }
                    });
                }

                // Export payment data event listener
                const exportBtn = document.getElementById('exportPaymentData');
                if (exportBtn) {
                    exportBtn.addEventListener('click', exportPaymentData);
                }
            });

    // Update navigation to load payment data when section is shown
    const originalNavClick = document.querySelector('.nav-link[data-section="payment-management"]');
    if (originalNavClick) {
        originalNavClick.addEventListener('click', () => {
            setTimeout(loadPaymentManagementData, 100);
        });
    }

    // Close modal when clicking outside
    window.onclick = function(event) {
        const modal = document.getElementById('securityReportModal');
        if (event.target === modal) {
            modal.style.display = 'none';
        }
    }

</script>

<!-- Security Report Modal -->
<div id="securityReportModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h2>üîí Full Security Report</h2>
            <span class="close" onclick="closeSecurityReportModal()">&times;</span>
        </div>
        <div class="modal-body" id="securityReportContent">
            <div class="loading">Loading full report...</div>
        </div>
    </div>
</div>
</body>
</html> 